import{G as Graphics,b as Container,T as Text,c as Texture,P as ParticleContainer,e as AnimatedSprite,S as Sprite,s as settings,f as Application,R as Rectangle,g as Color,h as Filter}from"./@pixi-BIl9izGx.js";import"./pixi.js-BD83xn3I.js";import"./eventemitter3-BgJIfPQV.js";import"./earcut-D5S9tiw3.js";import"./url-Cgwb902x.js";import{B as Bezier}from"./bezier-easing-BLJNtYhi.js";import{m as md5Hash}from"./md5-js-CojzrqMi.js";import{o as oggmentedAudioContext}from"./oggmented-BLN18-n-.js";import{M as Mp3Parser}from"./unify-mp3-timing-BniELK9l.js";import{F as FontFaceObserver}from"./fontfaceobserver-qmBRhu58.js";import{J as JSZip}from"./jszip-I_j6eaCf.js";import{p as processCanvasRGB}from"./stackblur-canvas-B9jW_Mwq.js";import{P as Pica}from"./pica-D-Lf_ID-.js";import"./ismobilejs-CHLuctl-.js";import"./punycode-BhK62wAl.js";import"./qs-B_K5Skv1.js";import"./side-channel-CnwTUEfj.js";import"./es-errors-CxTyLFAO.js";import"./object-inspect-CwR3nEST.js";import"./side-channel-list-YGX3S6EG.js";import"./side-channel-map-DfNa36Rb.js";import"./get-intrinsic-BpLglCTt.js";import"./es-object-atoms-BR76m4z7.js";import"./math-intrinsics-DP1tGiab.js";import"./gopd-C1lCZ5Qs.js";import"./es-define-property-D_7cP-M3.js";import"./has-symbols-BaUvM3gb.js";import"./get-proto-Cd0SCNDH.js";import"./dunder-proto-DSwuxXkl.js";import"./call-bind-apply-helpers-VtLnLD2e.js";import"./function-bind-CHqF18-c.js";import"./hasown-DwiY0sux.js";import"./call-bound-BuGV4nFB.js";import"./side-channel-weakmap-BqJyLiKX.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function i(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=i(n);fetch(n.href,r)}})();function bool(e,t=!1){return typeof e=="boolean"?!!e:t}function number(e,t=0,i=-1/0,s=1/0){return!isNaN(e)&&i<=parseFloat(e)&&parseFloat(e)<=s?parseFloat(e):t}function text(e,t=""){return typeof e=="string"&&e!=""?e:t}function touchStart(e){e.preventDefault();for(const t of e.changedTouches){const{clientX:i,clientY:s,identifier:n}=t;this.addInput("touch",n,i-this.renderSize.widthOffset,s)}}function touchMove(e){e.preventDefault();for(const t of e.changedTouches){const{clientX:i,clientY:s,identifier:n}=t;this.moveInput("touch",n,i-this.renderSize.widthOffset,s)}}function touchEnd(e){e.preventDefault();for(const t of e.changedTouches)this.removeInput("touch",t.identifier)}function mouseStart(e){e.preventDefault();const{clientX:t,clientY:i,button:s}=e;this.addInput("mouse",s,t-this.renderSize.widthOffset,i)}function mouseMove(e){const{clientX:t,clientY:i,button:s}=e;this.moveInput("mouse",s,t-this.renderSize.widthOffset,i)}function mouseEnd(e){this.removeInput("mouse",e.button)}const ListenerCallback={touchStart,touchMove,touchEnd,mouseStart,mouseMove,mouseEnd};class InputPoint{constructor(t,i,s,n){this.type=t,this.id=i,this.x=s,this.y=n,this.isActive=!0,this.isTapped=!1,this.isMoving=!1,this.isFlickable=!1,this.isFlicked=!1,this._deltaX=0,this._deltaY=0,this._lastDeltaX=0,this._lastDeltaY=0,this._currentTime=performance.now(),this._deltaTime=this._currentTime}move(t,i){this._lastDeltaX=this._deltaX,this._lastDeltaY=this._deltaY,this._deltaX=t-this.x,this._deltaY=i-this.y,this.x=t,this.y=i,this.isMoving=!0;{let s=performance.now();this._deltaTime=s-this._currentTime,this._currentTime=s}{let s=(this._deltaX*this._lastDeltaX+this._deltaY*this._lastDeltaY)/Math.sqrt(this._lastDeltaX**2+this._lastDeltaY**2)/this._deltaTime;this.isFlickable&&s<.5?(this.isFlickable=!1,this.isFlicked=!1):!this.isFlickable&&s>1&&(this.isFlickable=!0)}}}class Input{constructor(t={}){if(!t.canvas)throw new Error("You cannot add inputs without a canvas");this.inputs=[];for(const i in ListenerCallback)this["_"+i]=ListenerCallback[i].bind(this);this.addListenerToCanvas(t.canvas),this.reset()}addListenerToCanvas(t){if(!(t instanceof HTMLCanvasElement))throw new Error("This is not a canvas");const i={passive:!1};t.addEventListener("touchstart",this._touchStart,i),t.addEventListener("touchmove",this._touchMove,i),t.addEventListener("touchend",this._touchEnd,i),t.addEventListener("touchcancel",this._touchEnd,i),t.addEventListener("mousedown",this._mouseStart,i),t.addEventListener("mousemove",this._mouseMove),t.addEventListener("mouseup",this._mouseEnd)}removeListenerFromCanvas(t){if(!(t instanceof HTMLCanvasElement))throw new Error("This is not a canvas");t.removeEventListener("touchstart",this._touchStart),t.removeEventListener("touchmove",this._touchMove),t.removeEventListener("touchend",this._touchEnd),t.removeEventListener("touchcancel",this._touchEnd),t.removeEventListener("mousedown",this._mouseStart),t.removeEventListener("mousemove",this._mouseMove),t.removeEventListener("mouseup",this._mouseEnd)}reset(){this.inputs.length=0}createSprite(t,i=!0){i&&(this.sprite=new Graphics,this.sprite.zIndex=99999,t.addChild(this.sprite))}addInput(t,i,s,n){const{inputs:r}=this;let a=r.findIndex(o=>o.type===t&&o.id===i);a!==-1&&r.splice(a,1),r.push(new InputPoint(t,i,s,n))}moveInput(t,i,s,n){const{inputs:r}=this;let a=r.find(o=>o.type===t&&o.id===i);a&&a.move(s,n)}removeInput(t,i){const{inputs:s}=this;let n=s.find(r=>r.type===t&&r.id===i);n&&(n.isActive=!1)}calcTick(){const{inputs:t}=this;this.sprite&&this.sprite.clear();for(let i=0,s=t.length;i<s;i++){let n=t[i];this.sprite&&this.sprite.beginFill(n.isTapped?n.isMoving?65535:16711935:16776960).drawCircle(n.x,n.y,this._inputPointSize).endFill(),n.isActive?(n.isTapped=!0,n.isMoving=!1):(t.splice(i--,1),s-=1)}}resizeSprites(t){this.renderSize=t,this._inputPointSize=this.renderSize.heightPercent*30}destroySprites(){this.sprite&&(this.sprite.destroy(),this.sprite=void 0)}}class Score{constructor(t=0,i=!0,s=!1,n=!1){this._notesCount=Number(t),this._showAPStatus=!!i,this._autoPlay=!!n,(isNaN(this._notesCount)||this._notesCount<=0)&&(console.warn("Invaild note count, Won't calculate score."),this._notesCount=0),this.scorePerNote=s?1e6/t:9e5/t,this.scorePerCombo=s?0:1e5/t,this.renderSize={},this.reset()}reset(){this._score=0,this.score=0,this.acc=0,this.combo=0,this.maxCombo=0,this.judgedNotes=0,this.perfect=0,this.good=0,this.bad=0,this.miss=0,this.judgeLevel=-1,this.APType=2,this.levelPassed=!1,this.sprites&&(this.sprites.combo.number.text="0",this.sprites.acc.text="ACCURACY 0.00%",this.sprites.score.text="0000000",this.sprites.combo.text.position.x=this.sprites.combo.number.width+this.renderSize.heightPercent*6)}createSprites(t){this.sprites||(this.sprites={},this.sprites.combo={},this.sprites.combo.container=new Container,this.sprites.combo.container.zIndex=99999,this.sprites.combo.number=new Text("0",{fontFamily:"A-OTF Shin Go Pr6N H",fill:16777215}),this.sprites.combo.number.alpha=.81,this.sprites.combo.text=new Text(this._autoPlay?"AUTOPLAY":"COMBO",{fontFamily:"MiSans",fill:16777215}),this.sprites.combo.text.alpha=.55,this.sprites.combo.container.addChild(this.sprites.combo.number,this.sprites.combo.text),t.addChild(this.sprites.combo.container),this.sprites.acc=new Text("ACCURACY 0.00%",{fontFamily:"MiSans",fill:16777215}),this.sprites.acc.alpha=.63,this.sprites.acc.zIndex=99999,t.addChild(this.sprites.acc),this.sprites.score=new Text("0000000",{fontFamily:"A-OTF Shin Go Pr6N H",fill:16777215}),this.sprites.score.alpha=.58,this.sprites.score.anchor.set(1,0),this.sprites.score.zIndex=99999,t.addChild(this.sprites.score))}resizeSprites(t,i){this.renderSize=t,this.sprites&&(this.sprites.combo.number.style.fontSize=t.heightPercent*60,this.sprites.combo.text.style.fontSize=t.heightPercent*30,this.sprites.acc.style.fontSize=t.heightPercent*20,this.sprites.score.style.fontSize=t.heightPercent*50,i?(this.sprites.combo.container.position.y=t.height,this.sprites.acc.position.y=t.height,this.sprites.score.position.y=t.height):(this.sprites.combo.container.position.x=t.heightPercent*72,this.sprites.combo.container.position.y=t.heightPercent*41,this.sprites.combo.text.position.x=this.sprites.combo.number.width+t.heightPercent*6,this.sprites.combo.text.position.y=t.heightPercent*30,this.sprites.acc.position.x=t.heightPercent*72,this.sprites.acc.position.y=t.heightPercent*113,this.sprites.score.position.x=t.width-t.heightPercent*139,this.sprites.score.position.y=t.heightPercent*61))}pushJudge(t=0,i=[]){if(this._autoPlay)this.perfect+=1,this.combo+=1,this.maxCombo=this.combo,this._score+=this.scorePerNote+this.scorePerCombo;else if(t>2){if(this.combo+=1,this.combo>this.maxCombo&&(this.maxCombo=this.combo),t===4)this.perfect+=1;else if(this.good+=1,this.APType>=2&&(this.APType=1,this._showAPStatus))for(const s of i){if(!isNaN(s.color)||!s.sprite)return;s.sprite.tint=11854335}this._score+=this.scorePerNote+(this.combo>=this.maxCombo?this.scorePerCombo*(t===4?1:.65):0)}else{if(t===2?this.bad+=1:this.miss+=1,this.APType>=1&&(this.APType=0,this._showAPStatus))for(const s of i){if(!isNaN(s.color)||!s.sprite)return;s.sprite.tint=16777215}this.combo=0}this.judgedNotes++,this.score=Math.round(this._score),this.acc=(this.perfect+this.good*.65)/this.judgedNotes,this.score>=1e6?this.judgeLevel=6:this.score>=96e4?this.judgeLevel=5:this.score>=92e4?this.judgeLevel=4:this.score>=88e4?this.judgeLevel=3:this.score>=82e4?this.judgeLevel=2:this.score>=7e5?this.judgeLevel=1:this.judgeLevel=0,this.judgeLevel>=1&&(this.levelPassed=!0),this.sprites&&(this.sprites.combo.number.text=this.combo,this.sprites.acc.text="ACCURACY "+(this.acc*100).toFixed(2)+"%",this.sprites.score.text=fillZero(this.score.toFixed(0),7),this.sprites.combo.text.position.x=this.sprites.combo.number.width+this.renderSize.heightPercent*6)}destroySprites(){this.sprites&&(this.sprites.combo.number.destroy(),this.sprites.combo.text.destroy(),this.sprites.combo.container.destroy(),this.sprites.combo=void 0,this.sprites.acc.destroy(),this.sprites.acc=void 0,this.sprites.score.destroy(),this.sprites.score=void 0,this.sprites=void 0)}}function fillZero(e,t=3){let i=e+"";for(;i.length<t;)i="0"+i;return i}class JudgePoint{constructor(t,i=1){this.x=t.x,this.y=t.y,this.input=t,this.type=i}isInArea(t,i,s,n,r){return Math.abs((this.x-t)*s+(this.y-i)*n)<=r}}const particleCountPerClickAnim=4,AllJudgeTimes={bad:180,good:160,perfect:80,badChallenge:90,goodChallenge:75,perfectChallenge:40};var ClickAnimatePointCache;(async()=>{const t=document.createElement("canvas"),i=t.getContext("2d",{alpha:!0});t.width=t.height=26*2,i.clearRect(0,0,26*2,26*2),i.beginPath(),i.arc(26,26,26,0,Math.PI*2),i.fillStyle="#FFFFFF",i.fill();const s=Texture.from(await createImageBitmap(t));s.defaultAnchor.set(.5),Texture.addToCache(s,"clickAnimatePoint"),ClickAnimatePointCache=s})();class Judgement{constructor(t={}){if(this.chart=t.chart,this.stage=t.stage,this.textures=t.assets.textures,this.sounds=t.assets.sounds,!t.stage)throw new Error("You cannot do judgement without a stage");if(!t.chart)throw new Error("You cannot do judgement without a chart");this._autoPlay=bool(t.autoPlay,!1),this._hitsound=bool(t.hitsound,!0),this._hitsoundVolume=number(t.hitsoundVolume,1,0,1),this.score=new Score(this.chart.totalRealNotes,bool(t.showAPStatus,!0),bool(t.challangeMode,!1),this._autoPlay),this.input=new Input({canvas:t.canvas,autoPlay:this._autoPlay}),this.judgeTimes={perfect:(t.challangeMode?AllJudgeTimes.perfectChallenge:AllJudgeTimes.perfect)/1e3,good:(t.challangeMode?AllJudgeTimes.goodChallenge:AllJudgeTimes.good)/1e3,bad:(t.challangeMode?AllJudgeTimes.badChallenge:AllJudgeTimes.bad)/1e3},this.calcTick=this.calcTick.bind(this),this.calcNote=calcNoteJudge.bind(this),this.reset()}reset(){this.judgePoints=[],this.score.reset(),this.input.reset(),this._holdBetween=.15,this.clickParticleContainer&&this.clickParticleContainer.removeChildren()}createSprites(t=!0){this.clickParticleContainer=new ParticleContainer(1500,{vertices:!0,position:!0,scale:!0,tint:!0}),this.clickParticleContainer.zIndex=99999,this.stage.addChild(this.clickParticleContainer),this.score.createSprites(this.stage),this.input.createSprite(this.stage,t),this._clickAnimBaseScale={normal:256/this.textures.normal[0].baseTexture.width,bad:256/this.textures.bad[0].baseTexture.width}}resizeSprites(t,i){this.renderSize=t,this.score.resizeSprites(t,i),this.input.resizeSprites(t,i)}calcTick(){this.createJudgePoints(),this.input.calcTick();for(let t=0,i=this.clickParticleContainer.children.length;t<i;t++){const s=this.clickParticleContainer.children[t];if(!s)break;const n=(Date.now()-s.startTime)/500;if(n>=1){s.destroy(!1);continue}s.alpha=1-n,s.scale.set((((.2078*n-1.6524)*n+1.6399)*n+.4988)*s.baseScale),s.distance=s._distance*(9*n/(8*n+1))*.6*s.baseScale,s.position.x=s.distance*s.cosr-s.distance*s.sinr+s.basePos.x,s.position.y=s.distance*s.cosr+s.distance*s.sinr+s.basePos.y}}createJudgePoints(){if(this.judgePoints.length=0,!this._autoPlay)for(let t=0,i=this.input.inputs.length;t<i;t++){let s=this.input.inputs[t];s.isTapped||this.judgePoints.push(new JudgePoint(s,1)),s.isActive&&this.judgePoints.push(new JudgePoint(s,3)),s.isFlickable&&!s.isFlicked&&this.judgePoints.push(new JudgePoint(s,2))}}pushNoteJudge(t){this.score.pushJudge(t.score,this.chart.judgelines),t.score>=2&&(this.createClickAnimate(t),t.score>=3&&this.playHitsound(t))}createClickAnimate(t){let i=new AnimatedSprite(t.score>=3?this.textures.normal:this.textures.bad),s=this.renderSize.noteScale*5.6;if(t.score>=3&&t.type!=3?i.position.set(t.sprite.judgelineX,t.sprite.judgelineY):i.position.copyFrom(t.sprite.position),i.scale.set((t.score>=3?this._clickAnimBaseScale.normal:this._clickAnimBaseScale.bad)*s),i.tint=t.score===4?16772256:t.score===3?11854335:7095107,i.loop=!1,t.score>=3){let n=0;for(;n<particleCountPerClickAnim;){let r=new Sprite(ClickAnimatePointCache);r.tint=t.score===4?16772256:11854335,r.startTime=Date.now(),r.basePos=i.position,r.baseScale=s,r.distance=r._distance=Math.random()*100+250,r.direction=Math.floor(Math.random()*360),r.sinr=Math.sin(r.direction),r.cosr=Math.cos(r.direction),this.clickParticleContainer.addChild(r),n++}}else i.angle=t.sprite.angle;return i.onFrameChange=function(){this.alpha=1-this.currentFrame/this.totalFrames},i.onComplete=function(){this.destroy(!1)},this.stage.addChild(i),i.play(),i}playHitsound(t){if(this._hitsound)if(t.hitsound)t.hitsound.play();else switch(t.type){case 1:case 3:{this.sounds.tap.play();break}case 2:{this.sounds.drag.play();break}case 4:{this.sounds.flick.play();break}}}destroySprites(){this.reset(),this.clickParticleContainer.destroy({children:!0,texture:!1,baseTexture:!1}),this.input.destroySprites(),this.score.destroySprites()}}function calcNoteJudge(e,t){if(t.isFake||t.isScored&&t.isScoreAnimated||t.time-this.judgeTimes.bad>e)return;if(!t.isScored){if(t.type!==3&&t.time+this.judgeTimes.bad<e){t.isScored=!0,t.score=1,t.scoreTime=NaN,this.score.pushJudge(0,this.chart.judgelines),t.sprite.alpha=0,t.isScoreAnimated=!0;return}else if(t.type===3&&t.time+this.judgeTimes.good<e){t.isScored=!0,t.score=1,t.scoreTime=NaN,this.score.pushJudge(0,this.chart.judgelines),t.sprite.alpha=.5,t.isScoreAnimated=!0;return}}let i=t.time-e,s=i>0?i:i*-1,n=t.judgeline,r=t.sprite.position;if(t.type!==3&&!t.isScoreAnimated&&t.time<=e&&(t.sprite.alpha=1+i/this.judgeTimes.bad),this._autoPlay){let a={x:r.x,y:r.y,isFlicked:!1};t.type===1?i<=0&&this.judgePoints.push(new JudgePoint(a,1)):t.type===2?i<=this.judgeTimes.bad&&this.judgePoints.push(new JudgePoint(a,3)):t.type===3?!t.isScored&&i<=0?this.judgePoints.push(new JudgePoint(a,1)):t.isScored&&e-t.lastHoldTime>=this._holdBetween&&this.judgePoints.push(new JudgePoint(a,3)):t.type===4&&i<=this.judgeTimes.bad&&this.judgePoints.push(new JudgePoint(a,2))}switch(t.type){case 1:{for(let a=0,o=this.judgePoints.length;a<o;a++)if(this.judgePoints[a].type===1&&this.judgePoints[a].isInArea(r.x,r.y,n.cosr,n.sinr,this.renderSize.noteWidth)&&(s<=this.judgeTimes.bad&&(t.isScored=!0,t.scoreTime=i,s<=this.judgeTimes.perfect?t.score=4:s<=this.judgeTimes.good?t.score=3:t.score=2),t.isScored)){this.pushNoteJudge(t),t.sprite.alpha=0,t.isScoreAnimated=!0,this.judgePoints.splice(a,1);break}break}case 2:{if(t.isScored&&!t.isScoreAnimated&&i<=0)this.pushNoteJudge(t),t.sprite.alpha=0,t.isScoreAnimated=!0;else if(!t.isScored){for(let a=0,o=this.judgePoints.length;a<o;a++)if(this.judgePoints[a].isInArea(r.x,r.y,n.cosr,n.sinr,this.renderSize.noteWidth)&&s<=this.judgeTimes.good){t.isScored=!0,t.score=4,t.scoreTime=NaN;break}}break}case 3:{if(t.isScored){if(e-t.lastHoldTime>=this._holdBetween&&this.createClickAnimate(t),t.holdTimeLength-e<=this.judgeTimes.bad){this.score.pushJudge(t.score,this.chart.judgelines),t.isScoreAnimated=!0;break}e-t.lastHoldTime>=this._holdBetween&&(t.lastHoldTime=e,t.isHolding=!1)}for(let a=0,o=this.judgePoints.length;a<o;a++)if(!t.isScored&&this.judgePoints[a].type===1&&this.judgePoints[a].isInArea(r.x,r.y,n.cosr,n.sinr,this.renderSize.noteWidth)&&s<=this.judgeTimes.good){t.isScored=!0,t.scoreTime=i,s<=this.judgeTimes.perfect?t.score=4:t.score=3,this.createClickAnimate(t),this.playHitsound(t),t.isHolding=!0,t.lastHoldTime=e,this.judgePoints.splice(a,1);break}else this.judgePoints[a].isInArea(r.x,r.y,n.cosr,n.sinr,this.renderSize.noteWidth)&&(t.isHolding=!0);!this.paused&&t.isScored&&!t.isHolding&&(t.score=1,t.scoreTime=NaN,this.score.pushJudge(1,this.chart.judgelines),t.sprite.alpha=.5,t.isScoreAnimated=!0);break}case 4:{if(t.isScored&&!t.isScoreAnimated&&i<=0)this.pushNoteJudge(t),t.sprite.alpha=0,t.isScoreAnimated=!0;else if(!t.isScored){for(let a=0,o=this.judgePoints.length;a<o;a++)if(this.judgePoints[a].type===2&&this.judgePoints[a].isInArea(r.x,r.y,n.cosr,n.sinr,this.renderSize.noteWidth)&&s<=this.judgeTimes.good){t.isScored=!0,t.score=4,t.scoreTime=NaN,this.judgePoints[a].input.isFlicked=!0,this.judgePoints.splice(a,1);break}}break}}}function calcTick(){{let e=this.sprites.pauseButton;e.clickCount===1?e.alpha<1?e.alpha=.5+.5*((Date.now()-e.lastClickTime)/200):e.alpha>=1&&Date.now()-e.lastClickTime>=2e3?(e.clickCount=0,e.lastRenderTime=Date.now(),e.isEndRendering=!0):e.alpha>=1&&(e.alpha=1,e.lastRenderTime=Date.now()):e.clickCount===0&&e.isEndRendering&&(e.alpha>.5?e.alpha=1-.5*((Date.now()-e.lastRenderTime)/200):e.alpha<=.5&&(e.alpha=.5,e.lastRenderTime=Date.now(),e.isEndRendering=!1))}switch(this._animateStatus){case 0:{this._calcGameAnimateTick(!0);break}case 1:{let{chart:e,effects:t,judgement:i,functions:s,processors:n,sprites:r,render:a,_settings:o}=this,l=e.music.currentTime-(e.offset+o.offset);for(let h=0,c=e.bpmList.length;h<c;h++){let d=e.bpmList[h];if(!(d.endTime<l)){if(d.startTime>l)break;i._holdBetween=d.holdBetween}}for(let h=0,c=e.judgelines.length;h<c;h++){const d=e.judgelines[h];d.calcTime(l,a.sizer);for(let u=0,m=n.judgeline.length;u<m;u++)n.judgeline[u](d,l)}for(let h=0,c=e.notes.length;h<c;h++){const d=e.notes[h];d.calcTime(l,a.sizer);for(let u=0,m=n.note.length;u<m;u++)n.note[u](d,l);i.calcNote(l,d)}if(!this._isPaused){i.calcTick();for(let h=0,c=s.tick.length;h<c;h++)s.tick[h](this,l);if(o.shader){a.gameContainer.filters=[],a.stage.filters=[];for(let h=0,c=t.length;h<c;h++){const d=t[h];if(d.shader!==null&&!(d.endTime<l)){if(d.startTime>l)break;d.calcTime(l,a.sizer.shaderScreenSize),d.isGlobal?a.stage.filters.push(d.shader):a.gameContainer.filters.push(d.shader)}}}}r.progressBar.scale.x=e.music.progress*r.progressBar.baseScaleX;break}case 2:{this._calcGameAnimateTick(!1);break}}}function calcGameAnimateTick(e=!0){let t=(Date.now()-(e?this._gameStartTime:this._gameEndTime))/1500,i=e?1-Math.pow(1-t,4):Math.pow(1-t,4),s={score:this.judgement.score.sprites,chart:this.chart.sprites};s.score.combo.container.position.y=-(s.score.combo.container.height+s.score.acc.height)+(s.score.combo.container.height+s.score.acc.height+this.render.sizer.heightPercent*41)*i,s.score.acc.position.y=s.score.combo.container.position.y+this.render.sizer.heightPercent*72,s.score.score.position.y=-s.score.score.height+(s.score.score.height+this.render.sizer.heightPercent*61)*i,this.sprites.pauseButton.position.y=-this.sprites.pauseButton.height+(this.sprites.pauseButton.height+this.render.sizer.heightPercent*75)*i,this.sprites.progressBar.position.y=-(this.render.sizer.heightPercent*12)*(1-i),s.chart.info.songName.position.y=this.render.sizer.height+s.chart.info.songName.height-(s.chart.info.songName.height+this.render.sizer.heightPercent*66)*i,s.chart.info.songDiff.position.y=s.chart.info.songName.position.y+this.render.sizer.heightPercent*24,this.sprites.fakeJudgeline.width=this.render.sizer.width*i,this.chart.sprites.bg&&this.chart.sprites.bg.cover&&(this.chart.sprites.bg.cover.alpha=this._settings.bgDim*i),t>=1&&(e?(this._animateStatus=1,this.resize(!0,!1),setTimeout(async()=>{this.chart.music.play(!0);for(const n of this.chart.judgelines)n.sprite&&(n.sprite.alpha=1,n.debugSprite&&(n.debugSprite.visible=!0));for(const n of this.chart.notes)n.sprite&&(n.sprite.alpha=n.basicAlpha);this._isPaused=!1,this._isEnded=!1,this.sprites.fakeJudgeline.visible=!1,this._runCallback("start")},200)):(this._animateStatus=3,this._isPaused=!0,this._isEnded=!0,this._runCallback("end")))}const TickerFunc=Object.freeze(Object.defineProperty({__proto__:null,calcGameAnimateTick,calcTick},Symbol.toStringTag,{value:"Module"}));function onKeyPressCallback(e){let t=e.keyCode,i=e.ctrlKey,s=e.shiftKey,n=0;if(!this._isPaused&&this._settings.autoPlay&&this._animateStatus===1){switch(t){case 37:{n=-2;break}case 39:{n=2;break}default:return}i&&s?n*=5:i?n*=2:s&&(n*=.5);{let o=function(l,h=3){let c=l+"";for(;c.length<h;)c="0"+c;return c},r=this.chart.music.currentTime,a=0;for(const l of this.chart.notes)if(!l.isFake){if(l.score<=0)break;if(l.time<r){a++;continue}l.reset()}this.judgement.score.perfect=this.judgement.score.judgedNotes=this.judgement.score.combo=this.judgement.score.maxCombo=a,this.judgement.score._score=(this.judgement.score.scorePerNote+this.judgement.score.scorePerCombo)*a,this.judgement.score.sprites&&(this.judgement.score.sprites.combo.number.text=this.judgement.score.combo,this.judgement.score.sprites.acc.text="ACCURACY "+(this.judgement.score.acc*100).toFixed(2)+"%",this.judgement.score.sprites.score.text=o(this.judgement.score.score.toFixed(0),7),this.judgement.score.sprites.combo.text.position.x=this.judgement.score.sprites.combo.number.width+this.render.sizer.heightPercent*6)}this.chart.music.seek(n)}}function pauseBtnClickCallback(){let e=this.sprites.pauseButton;e.clickCount++,e.clickCount>=2&&Date.now()-e.lastClickTime<=2e3&&(this.pause(),e.lastRenderTime=Date.now(),e.isEndRendering=!0,e.clickCount=0),e.lastClickTime=Date.now()}function gameEndCallback(){this._animateStatus=2,this._gameEndTime=Date.now(),this.sprites.fakeJudgeline.visible=!0,this.judgement.clickParticleContainer.removeChildren(),this._settings.showAPStatus&&(this.judgement.score.APType===1?this.sprites.fakeJudgeline.tint=11854335:this.judgement.score.APType===0&&(this.sprites.fakeJudgeline.tint=16777215));for(const e of this.chart.judgelines)e.sprite&&(e.sprite.alpha=0,e.debugSprite&&(e.debugSprite.visible=!1));for(const e of this.chart.notes)e.sprite&&(e.sprite.alpha=0,e.debugSprite&&(e.debugSprite.visible=!1));this.judgement.input.sprite&&this.judgement.input.sprite.clear()}function runCallback(e){this.functions[e]&&this.functions[e].forEach(t=>t(this))}const CallbackFunc=Object.freeze(Object.defineProperty({__proto__:null,gameEndCallback,onKeyPressCallback,pauseBtnClickCallback,runCallback},Symbol.toStringTag,{value:"Module"}));settings.RENDER_OPTIONS.hello=!0;const ProgressBarCache=(()=>{const e=document.createElement("canvas"),t=e.getContext("2d");e.width=1920,e.height=12,t.clearRect(0,0,1920,12),t.fillStyle="#FFFFFF",t.fillRect(0,0,1920,12);const i=Texture.from(e);return Texture.addToCache(i,"progressBar"),i})();class Game{constructor(t){let i={...t};if(i.render||(i.render={}),i.settings||(i.settings={}),this.chart=i.chart,this.assets=i.assets,this.effects=i.settings.shader&&i.effects instanceof Array&&i.effects.length>0?i.effects:[],this.zipFiles=i.zipFiles,!this.chart)throw new Error("You must select a chart to play");if(!this.assets)throw new Error("Render must use a texture object for creating sprites.");this.zipFiles||(this.zipFiles={}),this.render=new Application({width:number(i.render.width,document.documentElement.clientWidth,0),height:number(i.render.height,document.documentElement.clientHeight,0),resolution:number(i.render.resolution,window.devicePixelRatio,1),autoDensity:bool(i.render.autoDensity,!0),antialias:bool(i.render.antialias,!0),view:i.render.canvas?i.render.canvas:void 0,backgroundAlpha:1}),this.render.parentNode=i.render.resizeTo?i.render.resizeTo:i.render.canvas?i.render.canvas.parentNode:this.render.view.parentElement,this.render.mainContainer=new Container,this.render.mainContainer.zIndex=10,this.render.stage.addChild(this.render.mainContainer),this.render.gameContainer=new Container,this.render.gameContainer.zIndex=20,this.render.mainContainer.addChild(this.render.gameContainer),this.render.UIContainer=new Container,this.render.UIContainer.zIndex=30,this.render.mainContainer.addChild(this.render.UIContainer),this.render.mainContainerMask=new Graphics,this.render.mainContainerMask.cacheAsBitmap=!0,this.judgement=new Judgement({chart:this.chart,stage:this.render.UIContainer,canvas:this.render.view,assets:{textures:{normal:this.assets.textures.clickRaw,bad:this.assets.textures.clickRaw},sounds:{tap:this.assets.sounds.tap,drag:this.assets.sounds.drag,flick:this.assets.sounds.flick}},hitsound:bool(i.settings.hitsound,!0),hitsoundVolume:number(i.settings.hitsoundVolume,1,0,1),showAPStatus:bool(i.settings.showAPStatus,!0),challengeMode:bool(i.settings.challengeMode,!1),autoPlay:bool(i.settings.autoPlay,!1)}),this.sprites={},this.functions={start:[],tick:[],pause:[],end:[]},this.processors={judgeline:[],note:[]},this._settings={resolution:number(i.render.resolution,window.devicePixelRatio,1),noteScale:number(i.settings.noteScale,8e3),bgDim:number(i.settings.bgDim,.5,0,1),offset:number(i.settings.audioOffset,0),speed:number(i.settings.speed,1,0,2),showFPS:bool(i.settings.showFPS,!0),showInputPoint:bool(i.settings.showInputPoint,!0),multiNoteHL:bool(i.settings.multiNoteHL,!0),showAPStatus:bool(i.settings.showAPStatus,!0),challengeMode:bool(i.settings.challengeMode,!1),autoPlay:bool(i.settings.autoPlay,!1),debug:bool(i.settings.debug,!1),shader:bool(i.settings.shader,!0)},this._watermarkText=text(i.watermark,"github/MisaLiu/phi-chart-render"),this._audioOffset=0,this._animateStatus=NaN,this._gameStartTime=NaN,this._gameEndTime=NaN,this._isPaused=!1,this._isEnded=!1,this._currentEffects=[],this.resize=this.resize.bind(this);for(const s in TickerFunc)this["_"+s]=TickerFunc[s].bind(this);for(const s in CallbackFunc)this["_"+s]=CallbackFunc[s].bind(this);if(this._settings.speed<.25)throw new Error("Speed too slow");if(this._settings.speed>2)throw new Error("Speed too fast");this.resize(!1),window.addEventListener("resize",this.resize),this._settings.autoPlay&&window.addEventListener("keydown",this._onKeyPressCallback)}createSprites(){if(this.chart.bg){this.render.mainContainerCover=new Sprite(this.chart.bg);let t=new Graphics;t.beginFill(0),t.drawRect(0,0,this.render.mainContainerCover.texture.width,this.render.mainContainerCover.texture.height),t.endFill(),t.position.x=-this.render.mainContainerCover.width/2,t.position.y=-this.render.mainContainerCover.height/2,t.alpha=.5,this.render.mainContainerCover.zIndex=1,this.render.mainContainerCover.addChild(t),this.render.mainContainerCover.anchor.set(.5),this.render.stage.addChild(this.render.mainContainerCover)}if(this.chart.createSprites(this.render.gameContainer,this.render.sizer,this.assets.textures,this.render.UIContainer,this.zipFiles,this._settings.speed,this._settings.bgDim,this._settings.multiNoteHL,this._settings.debug),this._settings.showAPStatus)for(const t of this.chart.judgelines)t.sprite&&(t.sprite.tint=16772256);this.judgement.stage=this.render.UIContainer,this.judgement.createSprites(this._settings.showInputPoint),this.sprites.progressBar=new Sprite(ProgressBarCache),this.sprites.progressBar.width=0,this.sprites.progressBar.alpha=.75,this.sprites.progressBar.zIndex=99999,this.render.UIContainer.addChild(this.sprites.progressBar),this.sprites.pauseButton=new Sprite(this.assets.textures.pauseButton),this.sprites.pauseButton.eventMode="static",this.sprites.pauseButton.buttonMode=!0,this.sprites.pauseButton.on("pointerdown",this._pauseBtnClickCallback),this.sprites.pauseButton.hitArea=new Rectangle(-(this.sprites.pauseButton.texture.width*1.5),-(this.sprites.pauseButton.texture.height/2),this.sprites.pauseButton.texture.width*2,this.sprites.pauseButton.texture.height*2),this.sprites.pauseButton.clickCount=0,this.sprites.pauseButton.lastClickTime=Date.now(),this.sprites.pauseButton.isEndRendering=!1,this.sprites.pauseButton.lastRenderTime=Date.now(),this.sprites.pauseButton.anchor.set(1,0),this.sprites.pauseButton.alpha=.5,this.sprites.pauseButton.zIndex=99999,this.render.UIContainer.addChild(this.sprites.pauseButton),this.sprites.fakeJudgeline=new Sprite(this.assets.textures.judgeline),this.sprites.fakeJudgeline.anchor.set(.5),this.sprites.fakeJudgeline.zIndex=99999,this._settings.showAPStatus&&(this.sprites.fakeJudgeline.tint=16772256),this.render.UIContainer.addChild(this.sprites.fakeJudgeline),this._settings.showFPS&&(this.render.fpsText=new Text("FPS: 0",{fontFamily:"MiSans",align:"right",fill:16777215}),this.render.fpsText.anchor.x=1,this.render.fpsText.alpha=.5,this.render.fpsText.zIndex=999999,this.render.UIContainer.addChild(this.render.fpsText)),this.render.watermark=new Text(this._watermarkText,{fontFamily:"MiSans",align:"right",fill:16777215}),this.render.watermark.anchor.set(1),this.render.watermark.alpha=.5,this.render.watermark.zIndex=999999,this.render.mainContainer.addChild(this.render.watermark),this.render.gameContainer.sortChildren(),this.render.UIContainer.sortChildren(),this.render.mainContainer.sortChildren(),this.render.stage.sortChildren(),this.effects.forEach(t=>{if(t.shader instanceof Shader)return;if(!t.shader||typeof t.shader!="string"){t.shader=null;return}const i=t.shader;let s=null;if(i.indexOf("/")===0){const n=i.substr(1);this.zipFiles[n]&&(s=this.zipFiles[n])}else Shader.presets[i]&&(s=new Shader(Shader.presets[i],i));t.shader=s,t.shader||(console.log("'"+i+"' not found, will be ignored"),t.shader=null)})}start(){if(this.render){if(!this.chart.music)throw new Error("You must have a music to play");this.resize();for(const t of this.effects)t.reset();this.render.fpsText&&(this.render.fpsCounter=setInterval(()=>{this.render.fpsText.text="FPS: "+this.render.ticker.FPS.toFixed(0)},500)),this.chart.music.speed=this._settings.speed,this.chart.music.onend=this._gameEndCallback,this._animateStatus=0,this._gameStartTime=Date.now(),this.chart.noteJudgeCallback=this.judgement.calcNote,this.render.ticker.add(this._calcTick);for(const t of this.chart.judgelines)t.sprite&&(t.sprite.alpha=0,t.debugSprite&&(t.debugSprite.visible=!1));for(const t of this.chart.notes)t.sprite&&(t.sprite.alpha=0,t.debugSprite&&(t.debugSprite.visible=!1),t.hitsound&&(t.hitsound.volume=this.judgement._hitsoundVolume));for(const t in this.judgement.sounds)this.judgement.sounds[t].volume=this.judgement._hitsoundVolume}}pause(){this._isPaused=!this._isPaused,this.judgement.input._isPaused=this._isPaused,this._isPaused?(this.chart.music.pause(),this._runCallback("pause")):this.chart.music.play(!0)}restart(){this.render.ticker.remove(this._calcTick),this.chart.music.reset(),this.chart.reset(),this.judgement.reset(),this.resize();for(const t of this.effects)t.reset();this._isPaused=!1,this._isEnded=!1,this._animateStatus=0,this._gameStartTime=Date.now(),this._gameEndTime=NaN,this.render.ticker.add(this._calcTick),this._settings.showAPStatus&&(this.sprites.fakeJudgeline.tint=16772256),this.sprites.fakeJudgeline.visible=!0;for(const t of this.chart.judgelines)t.sprite&&(t.sprite.alpha=0,this._settings.showAPStatus&&(t.sprite.tint=16772256),t.debugSprite&&(t.debugSprite.visible=!1));for(const t of this.chart.notes)t.sprite&&(t.sprite.alpha=0,t.debugSprite&&(t.debugSprite.visible=!1))}destroy(t=!1){const i=this.render.view;this.render.ticker.remove(this._calcTick),this.chart.music.reset(),this.render.fpsText&&clearInterval(this.render.fpsCounter),this.chart.reset(),this.chart.destroySprites(),this.judgement.destroySprites(),this.judgement.input.removeListenerFromCanvas(i),window.removeEventListener("resize",this.resize),window.removeEventListener("keydown",this._onKeyPressCallback),i.width=i.height=0,this.render.destroy(t,{children:!0,texture:!1,baseTexture:!1})}on(t,i){this.functions[t]&&i instanceof Function&&this.functions[t].push(i)}addProcessor(t,i){this.processors[t]&&i instanceof Function&&this.processors[t].push(i)}resize(t=!0,i=!0){if(this.render){if(this.render.renderer.resize(this.render.parentNode.clientWidth,this.render.parentNode.clientHeight),this.render.sizer=calcResizer(this.render.screen.width,this.render.screen.height,this._settings.noteScale,this._settings.resolution),this.render.mainContainer.position.x=this.render.sizer.widthOffset,this.render.sizer.widerScreen&&this.render.mainContainer?(this.render.mainContainer.mask=this.render.mainContainerMask,this.render.mainContainerMask.visible=!0,this.render.mainContainerMask.clear().beginFill(16777215).drawRect(this.render.sizer.widthOffset,0,this.render.sizer.width,this.render.sizer.height).endFill()):(this.render.mainContainer.mask=null,this.render.mainContainerMask.visible=!1),this.render.sizer.widerScreen&&this.render.mainContainerCover){let s=this.render.screen.width/this.render.mainContainerCover.texture.width,n=this.render.screen.height/this.render.mainContainerCover.texture.height,r=s>n?s:n;this.render.mainContainerCover.scale.set(r),this.render.mainContainerCover.position.set(this.render.screen.width/2,this.render.screen.height/2),this.render.mainContainerCover.visible=!0}else this.render.mainContainerCover&&(this.render.mainContainerCover.visible=!1);!this._isEnded&&this.sprites&&(this.sprites.progressBar&&(this.sprites.progressBar.position.set(0,0),this.sprites.progressBar.scale.y=this.render.sizer.heightPercent,this.sprites.progressBar.baseScaleX=this.render.sizer.width/this.sprites.progressBar.texture.baseTexture.width),this.sprites.pauseButton&&(this.sprites.pauseButton.position.x=this.render.sizer.width-this.render.sizer.heightPercent*72,this.sprites.pauseButton.position.y=this.render.sizer.heightPercent*75,this.sprites.pauseButton.scale.set(.94*this.render.sizer.heightPercent)),this.sprites.fakeJudgeline&&(this.sprites.fakeJudgeline.position.x=this.render.sizer.width/2,this.sprites.fakeJudgeline.position.y=this.render.sizer.height/2,this.sprites.fakeJudgeline.height=this.render.sizer.lineScale*18.75*.008,(i||this._isEnded)&&(this.sprites.fakeJudgeline.width=0))),this.render.fpsText&&(this.render.fpsText.position.x=this.render.sizer.width,this.render.fpsText.position.y=0,this.render.fpsText.style.fontSize=this.render.sizer.heightPercent*32,this.render.fpsText.style.padding=this.render.sizer.heightPercent*8),this.render.watermark&&(this.render.watermark.position.x=this.render.sizer.width,this.render.watermark.position.y=this.render.sizer.height,this.render.watermark.style.fontSize=this.render.sizer.heightPercent*24),t&&(this.judgement.resizeSprites(this.render.sizer,this._isEnded),this.chart.resizeSprites(this.render.sizer,this._isEnded))}}gameTimeInSec(){return(Date.now()-this._gameStartTime)/1e3}}function calcResizer(e,t,i=8e3,s=window.devicePixelRatio){let n={};return n.shaderScreenSize=[e*s,t*s],n.width=t/9*16<e?t/9*16:e,n.height=t,n.widthPercent=n.width*(9/160),n.widthOffset=(e-n.width)/2,n.widerScreen=n.width<e,n.startX=-n.width/12,n.endX=n.width*(13/12),n.startY=-n.height/12,n.endY=n.height*(13/12),n.noteSpeed=n.height*.6,n.noteScale=n.width/i,n.noteWidth=n.width*.117775,n.lineScale=n.width>n.height*.75?n.height/18.75:n.width/14.0625,n.heightPercent=n.height/1080,n.textureScale=n.height/750,n}const calcBetweenTime$1=.125;function calculateEventBeat(e){return e.startTime=parseFloat((e.startTime[0]+e.startTime[1]/e.startTime[2]).toFixed(3)),e.endTime=parseFloat((e.endTime[0]+e.endTime[1]/e.endTime[2]).toFixed(3)),e}function calculateEventsBeat(e){return e.forEach(t=>{t=calculateEventBeat(t)}),e}function valueCalculator$2(e,t,i,s=1){if(e.start==e.end)return e.start;if(e.startTime>i)throw new Error("currentTime must bigger than startTime");if(e.endTime<i)throw new Error("currentTime must smaller than endTime");let n=(i-e.startTime)/(e.endTime-e.startTime),r=1-n;if(e.bezier===1){let a=Bezier(e.bezierPoints[0],e.bezierPoints[1],e.bezierPoints[2],e.bezierPoints[3]);return e.start*a(r)+e.end*a(n)}else{let a=t[e.easingType-s]?t[e.easingType-s]:t[0],o=a(number(e.easingLeft,0,0,1)*r+number(e.easingRight,1,0,1)*n),l=a(number(e.easingLeft,0,0,1)),h=a(number(e.easingRight,1,0,1));return o=(o-l)/(h-l),e.start*(1-o)+e.end*o}}function calculateRealTime(e,t){let i=e.slice(),s=t.slice();return s.forEach(n=>{for(let r=0,a=i.length;r<a;r++){let o=i[r];if(!(o.startBeat>n.endTime)){n.endTime=o.startTime+(n.endTime-o.startBeat)*o.beatTime;for(let l=r;l<a;l++){let h=i[l];if(!(h.startBeat>n.startTime)){n.startTime=h.startTime+(n.startTime-h.startBeat)*h.beatTime;break}}break}}}),s.slice()}function calculateEventEase(e,t,i=1,s=!1){let n=[],r=e.endTime-e.startTime;if(!e)return[];if((e.bezier==1||e.easingType&&t[e.easingType-i]&&(e.easingType-i!==0||s)&&e.easingType<=t.length)&&e.start!=e.end)for(let a=0,o=Math.ceil(r/calcBetweenTime$1);a<o;a++){let l=e.startTime+a*calcBetweenTime$1,h=e.startTime+(a+1)*calcBetweenTime$1<=e.endTime?e.startTime+(a+1)*calcBetweenTime$1:e.endTime;n.push({startTime:l,endTime:h,start:valueCalculator$2(e,t,l,i),end:valueCalculator$2(e,t,h,i)})}else n.push({startTime:e.startTime,endTime:e.endTime,start:e.start,end:e.end});return n}function calculateHoldBetween(e){let t=e.slice(),i=[];return t.sort((s,n)=>s.startTime-n.startTime),t.forEach(s=>{i.length<=0?i.push({startTime:s.startTime,endTime:s.startTime,bpm:s.bpm,holdBetween:(-1.2891*s.bpm+396.71)/1e3}):(i[i.length-1].endTime=s.startTime,i[i.length-1].bpm!=s.bpm&&i.push({startTime:s.startTime,endTime:s.startTime,bpm:s.bpm,holdBetween:(-1.2891*s.bpm+396.71)/1e3}))}),i.sort((s,n)=>s.startTime-n.startTime),i.length>0?(i[0].startTime=-999,i[i.length-1].endTime=1e4):i.push({startTime:-999,endTime:1e4,bpm:120,holdBetween:.242018}),i}function arrangeSameValueEvent(e){if(!e||e.length<=0)return[];let t=e.slice(),i=[t.shift()];for(const s of t)i[i.length-1].start==i[i.length-1].end&&s.start==s.end&&i[i.length-1].start==s.start?i[i.length-1].endTime=s.endTime:i.push(s);return i.slice()}function arrangeSameSingleValueEvent(e){if(!e||e.length<=0)return[];let t=[];for(let i of e){let s=t[t.length-1];!s||s.value!=i.value?t.push(i):s.endTime=i.endTime}return t.slice()}const utils={CalcBetweenTime:calcBetweenTime$1,calculateEventBeat,calculateEventsBeat,valueCalculator:valueCalculator$2,calculateRealTime,calculateEventEase,calculateHoldBetween,arrangeSameValueEvent,arrangeSameSingleValueEvent};class Judgeline{constructor(t){this.id=number(t.id,-1,0),this.texture=t.texture?t.texture:null,this.parentLine=t.parentLine||t.parentLine===0?t.parentLine:null,this.zIndex=number(t.zIndex,NaN),this.isCover=bool(t.isCover,!0),this.useOfficialScale=!1,this.eventLayers=[],this.floorPositions=[],this.extendEvent={color:[],scaleX:[],scaleY:[],text:[],incline:[]},this.noteControls={alpha:[],scale:[],x:[]},this.isText=!1,this.sprite=void 0,this.reset()}reset(){this.speed=1,this.x=.5,this.y=.5,this.alpha=1,this.deg=0,this.sinr=0,this.cosr=1,this.floorPosition=0,this.baseScaleX=3,this.baseScaleY=2.88,this.extendEvent.scaleX.length>0&&this.extendEvent.scaleX[0].startTime<=0?this.scaleX=this.extendEvent.scaleX[0].start:this.scaleX=1,this.extendEvent.scaleY.length>0&&this.extendEvent.scaleY[0].startTime<=0?this.scaleY=this.extendEvent.scaleY[0].start:this.scaleY=1,this.inclineSinr=NaN,this.color=NaN,this.sprite&&(this.sprite.alpha=1,this.sprite.angle=0,this.sprite.scale.set(1),this.isText&&(this.sprite.text=""))}sortEvent(t=!1){this.eventLayers.forEach(i=>{i.sort()});for(const i in this.extendEvent)this.extendEvent[i].sort((s,n)=>s.startTime-n.startTime);for(const i in this.eventLayers[0])i=="speed"||!(this.eventLayers[0][i]instanceof Array)||this.eventLayers[0][i].length<=0||this.eventLayers[0][i][0].startTime<=0||this.eventLayers[0][i].unshift({startTime:-99,endTime:this.eventLayers[0][i][0].startTime,start:0,end:0});for(const i in this.noteControls)this.noteControls[i].sort((s,n)=>n.y-s.y)}calcFloorPosition(){if(this.eventLayers.length<=0)throw new Error("No event layer in this judgeline");let t=0;this.eventLayers.forEach(r=>{r.speed=utils.arrangeSameSingleValueEvent(r.speed),r.speed.length<1&&t++}),t==this.eventLayers.length&&(console.warn("Line "+this.id+" don't have any speed event, use default speed."),this.eventLayers[0].speed.push({startTime:0,endTime:1e4,start:1,end:1}));let i={},s=0,n=[];this.floorPositions=[],this.eventLayers.forEach((r,a)=>{r.speed.forEach((o,l)=>{o.endTime=r.speed[l+1]?r.speed[l+1].startTime:1e4;let h=o.startTime.toFixed(3);i[h]||n.push({startTime:o.startTime,endTime:NaN,floorPosition:NaN}),i[h]=!0}),a===0&&r.speed[0].startTime>0&&r.speed.unshift({startTime:-99,endTime:r.speed[0]?r.speed[0].startTime:1e4,value:r.speed[0]?r.speed[0].value:1})}),n.sort((r,a)=>r.startTime-a.startTime),n.unshift({startTime:-999,endTime:n[0]?n[0].startTime:1e4,floorPosition:-999}),s+=n[0].endTime;for(let r=1;r<n.length;r++){let a=n[r],o=r<n.length-1?n[r+1]:{startTime:1e4},l=a.startTime;n[r].floorPosition=s,n[r].endTime=o.startTime,s+=(o.startTime-a.startTime)*this._calcSpeedValue(l)}this.floorPositions=n}getFloorPosition(t){if(this.floorPositions.length<=0)throw new Error("No floorPosition created, please call calcFloorPosition() first");let i={};for(const s of this.floorPositions)if(!(s.endTime<t)){if(s.startTime>t)break;i.startTime=s.startTime,i.endTime=s.endTime,i.floorPosition=s.floorPosition}return i.value=this._calcSpeedValue(t),i}_calcSpeedValue(t){let i=0;return this.eventLayers.forEach(s=>{let n=0;for(const r of s.speed)if(!(r.endTime<t)){if(r.startTime>t)break;n=r.value}i+=n}),i}createSprite(t,i,s=!1){if(this.sprite)return this.sprite;if(this.isText?this.sprite=new Text("",{fontFamily:"MiSans",align:"center",fill:16777215}):(this.sprite=new Sprite(i[this.texture]?i[this.texture]:t.judgeline),this.texture&&(this.baseScaleX=this.baseScaleY=1)),this.sprite.anchor.set(.5),this.sprite.alpha=1,s){let n=new Container,r=new Text(this.id,{fontSize:48,fill:16711840}),a=new Graphics().beginFill(16711840).drawRect(-22,-22,44,44).endFill();r.anchor.set(.5),r.position.set(0,-36-r.width/2),n.addChild(r),n.addChild(a),this.debugSprite=n}return this.extendEvent.scaleX.length>0&&this.extendEvent.scaleX[0].startTime<=0&&(this.scaleX=this.extendEvent.scaleX[0].start),this.extendEvent.scaleY.length>0&&this.extendEvent.scaleY[0].startTime<=0&&(this.scaleY=this.extendEvent.scaleY[0].start),this.sprite}calcTime(t,i){this.speed=0,this.x=0,this.y=0,this.alpha=0,this.deg=0;for(let s=0,n=this.eventLayers.length;s<n;s++){let r=this.eventLayers[s];r.calcTime(t),this.speed+=r._speed,this.x+=r._posX,this.y+=r._posY,this.alpha+=r._alpha,this.deg+=r._rotate}for(let s=0,n=this.floorPositions.length;s<n;s++){let r=this.floorPositions[s];if(!(r.endTime<t)){if(r.startTime>t)break;this.floorPosition=(t-r.startTime)*this.speed+r.floorPosition}}for(let s=0,n=this.extendEvent.scaleX.length;s<n;s++){let r=this.extendEvent.scaleX[s];if(r.endTime<t)continue;if(r.startTime>t)break;let a=(t-r.startTime)/(r.endTime-r.startTime),o=1-a;this.scaleX=r.start*o+r.end*a,this.sprite.scale.x=this.scaleX*this.baseScaleX}for(let s=0,n=this.extendEvent.scaleY.length;s<n;s++){let r=this.extendEvent.scaleY[s];if(r.endTime<t)continue;if(r.startTime>t)break;let a=(t-r.startTime)/(r.endTime-r.startTime),o=1-a;this.scaleY=r.start*o+r.end*a,this.sprite.scale.y=this.scaleY*this.baseScaleY}for(let s=0,n=this.extendEvent.text.length;s<n;s++){let r=this.extendEvent.text[s];if(!(r.endTime<t)){if(r.startTime>t)break;this.sprite.text=r.value}}for(let s=0,n=this.extendEvent.color.length;s<n;s++){let r=this.extendEvent.color[s];if(!(r.endTime<t)){if(r.startTime>t)break;this.color=this.sprite.tint=r.value}}for(let s=0,n=this.extendEvent.incline.length;s<n;s++){let r=this.extendEvent.incline[s];if(r.endTime<t)continue;if(r.startTime>t)break;let a=(t-r.startTime)/(r.endTime-r.startTime),o=1-a;this.inclineSinr=Math.sin(r.start*o+r.end*a)}if(this.cosr=Math.cos(this.deg),this.sinr=Math.sin(this.deg),this.parentLine){let s=(this.x*this.parentLine.cosr+this.y*this.parentLine.sinr)*.918554+this.parentLine.x,n=(this.y*this.parentLine.cosr-this.x*this.parentLine.sinr)*1.088662+this.parentLine.y;this.x=s,this.y=n}this.sprite.position.x=(this.x+.5)*i.width,this.sprite.position.y=(.5-this.y)*i.height,this.sprite.alpha=this.alpha>=0?this.alpha:0,this.sprite.rotation=this.deg,this.sprite.visible=this.alpha>0,this.debugSprite&&(this.debugSprite.position=this.sprite.position,this.debugSprite.rotation=this.sprite.rotation,this.debugSprite.alpha=.2+this.sprite.alpha*.8)}calcNoteControl(t,i,s){for(let n=0,r=this.noteControls[i].length;n<r;n++)if(this.noteControls[i][n].y<t)return this.noteControls[i][n-1].value;return s}}class EventLayer{constructor(){this.speed=[],this.moveX=[],this.moveY=[],this.alpha=[],this.rotate=[],this._speed=0,this._posX=0,this._posY=0,this._alpha=0,this._rotate=0}sort(){const t=(i,s)=>i.startTime-s.startTime;this.speed.sort(t),this.moveX.sort(t),this.moveY.sort(t),this.alpha.sort(t),this.rotate.sort(t)}calcTime(t){this._posX=valueCalculator$1(this.moveX,t,this._posX),this._posY=valueCalculator$1(this.moveY,t,this._posY),this._alpha=valueCalculator$1(this.alpha,t,this._alpha),this._rotate=valueCalculator$1(this.rotate,t,this._rotate);for(let i=0,s=this.speed.length;i<s;i++){let n=this.speed[i];if(!(n.endTime<t)){if(n.startTime>t)break;this._speed=n.value}}}}function valueCalculator$1(e,t,i=0){for(let s=0,n=e.length;s<n;s++){let r=e[s];if(r.endTime<t)continue;if(r.startTime>t)break;if(r.start==r.end)return r.start;let a=(t-r.startTime)/(r.endTime-r.startTime),o=1-a;return r.start*o+r.end*a}return i}class Note{constructor(t){if(this.id=number(t.id,-1,0),this.type=number(t.type,1,1,4),this.time=number(t.time,-1),this.holdTime=this.type===3?number(t.holdTime,0):0,this.holdTimeLength=this.type===3?parseFloat(this.time+this.holdTime):0,this.speed=number(t.speed,1),this.floorPosition=number(t.floorPosition,this.time),this.holdLength=this.type===3?number(t.holdLength,0):0,this.endPosition=parseFloat(this.floorPosition+this.holdLength),this.positionX=number(t.positionX,0),this.basicAlpha=number(t.basicAlpha,1,0,1),this.visibleTime=number(t.visibleTime,NaN,0,999998),this.yOffset=number(t.yOffset,0),this.xScale=number(t.xScale,1,0),this.isAbove=bool(t.isAbove,!0),this.isFake=bool(t.isFake,!1),this.isMulti=bool(t.isMulti,!1),this.useOfficialSpeed=bool(t.useOfficialSpeed,!1),this.texture=t.texture&&t.texture!=""?t.texture:null,this.hitsound=t.hitsound&&t.hitsound!=""?t.hitsound:null,this.judgeline=t.judgeline,this.sprite=void 0,!this.judgeline)throw new Error("Note must have a judgeline");this.reset()}reset(){this.isScored=!1,this.isScoreAnimated=!1,this.isHolding=!1,this.lastHoldTime=NaN,this.score=0,this.scoreTime=0,this.sprite&&(this.sprite.alpha=this.basicAlpha)}createSprite(t,i,s=!0,n=!1){if(this.sprite)return this.sprite;switch(this.type){case 1:{this.sprite=new Sprite(this.texture&&this.texture!=""?i[this.texture]:t["tap"+(this.isMulti&&s?"HL":"")]);break}case 2:{this.sprite=new Sprite(this.texture&&this.texture!=""?i[this.texture]:t["drag"+(this.isMulti&&s?"HL":"")]);break}case 3:{if(this.texture&&this.texture!="")this.sprite=new Sprite(i[this.texture]),this.sprite.anchor.set(.5,1),this.sprite.height=this.holdLength;else{this.sprite=new Container;let r=new Sprite(t["holdHead"+(this.isMulti&&s?"HL":"")]),a=new Sprite(t["holdBody"+(this.isMulti&&s?"HL":"")]),o=new Sprite(t.holdEnd);r.anchor.set(.5),a.anchor.set(.5,1),o.anchor.set(.5,1),a.height=this.holdLength,r.position.set(0,r.height/2),a.position.set(0,0),o.position.set(0,-a.height),this.sprite.addChild(r),this.sprite.addChild(a),this.sprite.addChild(o)}break}case 4:{this.sprite=new Sprite(this.texture&&this.texture!=""?i[this.texture]:t["flick"+(this.isMulti&&s?"HL":"")]);break}default:throw new Error("Unsupported note type: "+this.type)}if(this.type!==3&&this.sprite.anchor.set(.5),this.isAbove||(this.sprite.angle=180),this.sprite.alpha=this.basicAlpha,this.sprite.visible=!1,this.sprite.outScreen=!0,this.hitsound&&(this.hitsound=i[this.hitsound]),n){let r=new Container,a=new Text(this.judgeline.id+(this.isAbove?"+":"-")+this.id,{fontSize:48,fill:59135}),o=new Graphics().beginFill(59135).drawRect(-22,-22,44,44).endFill();a.anchor.set(.5),a.position.set(0,-36-a.height/2),a.angle=this.isAbove?0:180,r.addChild(a),r.addChild(o),this.debugSprite=r}return this.sprite}calcTime(t,i){let s=i.height*this.yOffset,n=s*(this.isAbove?-1:1),r=i.widthPercent*this.positionX,a=(this.floorPosition-this.judgeline.floorPosition)*(this.type===3&&this.useOfficialSpeed?1:this.speed)*i.noteSpeed+s,o=a*(this.isAbove?-1:1),l=o*this.judgeline.sinr*-1,h=o*this.judgeline.cosr,c=this.type===3?(this.useOfficialSpeed?this.holdTimeLength-t:this.endPosition-this.judgeline.floorPosition)*this.speed*i.noteSpeed:a,d=this.type===3?c*(this.isAbove?-1:1):o;if(!isNaN(this.judgeline.inclineSinr)&&this.type!==3){let u=1-this.judgeline.inclineSinr*a/360;this.sprite.scale.set(u*this.sprite.baseScale*this.xScale,u*this.sprite.baseScale),r*=u}if(this.type!==3&&(r*=this.judgeline.calcNoteControl(a,"x",1)),this.type===3&&(this.time<=t&&this.holdTimeLength>t?(l=h=0,this.sprite.children[0].visible=!1,this.sprite.children[1].height=c/i.noteScale,this.sprite.children[2].position.y=this.sprite.children[1].height*-1):this.sprite.children[0].visible=!0),this.sprite.judgelineX=r*this.judgeline.cosr+this.judgeline.sprite.position.x,this.sprite.judgelineY=r*this.judgeline.sinr+this.judgeline.sprite.position.y,l+=this.sprite.judgelineX,h+=this.sprite.judgelineY,this.sprite.judgelineX+=n*this.judgeline.sinr*-1,this.sprite.judgelineY+=n*this.judgeline.cosr,this.sprite.outScreen=!isInArea({startX:l,endX:r*this.judgeline.cosr-d*this.judgeline.sinr+this.judgeline.sprite.position.x,startY:h,endY:d*this.judgeline.cosr+r*this.judgeline.sinr+this.judgeline.sprite.position.y},i),this.sprite.visible=!this.sprite.outScreen,this.debugSprite&&(this.debugSprite.visible=!this.sprite.outScreen),this.sprite.position.x=l,this.sprite.position.y=h,this.sprite.angle=this.judgeline.sprite.angle+(this.isAbove?0:180),!this.sprite.outScreen){if(this.type!==3){let u=this.judgeline.calcNoteControl(a,"scale",1);this.sprite.scale.set(this.sprite.baseScale*this.xScale*u,this.sprite.baseScale*u),this.sprite.alpha=this.isScoreAnimated?0:this.basicAlpha*this.judgeline.calcNoteControl(a,"alpha",1)}else this.sprite.alpha=this.isScored&&this.score<=1?.5:this.basicAlpha*this.judgeline.calcNoteControl(a,"alpha",1);this.sprite.visible=this.sprite.alpha>0,this.type!==3&&this.time>t&&a<0&&this.judgeline.isCover&&(this.sprite.visible=!1),this.type!==3&&this.isFake&&this.time<=t&&(this.sprite.visible=!1),this.type===3&&(this.time>t&&a<0&&this.judgeline.isCover||this.holdTimeLength<=t)&&(this.sprite.visible=!1),!isNaN(this.visibleTime)&&this.time-t>this.visibleTime&&(this.sprite.visible=!1),this.judgeline.alpha<0&&(this.judgeline.alpha>=-1?this.sprite.visible=!1:this.judgeline.alpha>=-2&&(this.originY>0?this.sprite.visible=!1:this.originY<0&&(this.sprite.visible=!0))),this.debugSprite&&(this.debugSprite.position=this.sprite.position,this.debugSprite.angle=this.sprite.angle,this.debugSprite.alpha=.2+(this.sprite.visible?this.sprite.alpha*.8:0),this.time>t&&(this.sprite.visible?this.sprite.alpha=this.basicAlpha:(this.sprite.visible=!0,this.sprite.alpha=.2)))}}}function isInArea(e,t){let i=e.startX<=e.endX?e.startX:e.endX,s=e.startX<=e.endX?e.endX:e.startX,n=e.startY<=e.endY?e.startY:e.endY,r=e.startY<=e.endY?e.endY:e.startY;return i>=t.startX&&n>=t.startY&&s<=t.endX&&r<=t.endY||s>=t.startX&&r>=t.startY&&i<=t.endX&&n<=t.endY}function OfficialChartConverter(e){let t=new Chart,i=convertOfficialVersion(e),s=[],n={},r=[];return t.offset=i.offset,i.judgeLineList.forEach((o,l)=>{let h=new Judgeline({id:l}),c=new EventLayer,d=[];o.speedEvents.forEach(u=>{c.speed.push({startTime:calcRealTime(u.startTime,o.bpm),endTime:calcRealTime(u.endTime,o.bpm),value:u.value})}),o.judgeLineMoveEvents.forEach(u=>{c.moveX.push({startTime:calcRealTime(u.startTime,o.bpm),endTime:calcRealTime(u.endTime,o.bpm),start:u.start-.5,end:u.end-.5}),c.moveY.push({startTime:calcRealTime(u.startTime,o.bpm),endTime:calcRealTime(u.endTime,o.bpm),start:u.start2-.5,end:u.end2-.5})}),o.judgeLineRotateEvents.forEach(u=>{c.rotate.push({startTime:calcRealTime(u.startTime,o.bpm),endTime:calcRealTime(u.endTime,o.bpm),start:-(Math.PI/180)*u.start,end:-(Math.PI/180)*u.end})}),o.judgeLineDisappearEvents.forEach(u=>{c.alpha.push({startTime:calcRealTime(u.startTime,o.bpm),endTime:calcRealTime(u.endTime,o.bpm),start:u.start,end:u.end})}),h.eventLayers.push(c),h.sortEvent(),h.eventLayers[0].moveX=utils.arrangeSameValueEvent(h.eventLayers[0].moveX),h.eventLayers[0].moveY=utils.arrangeSameValueEvent(h.eventLayers[0].moveY),h.eventLayers[0].rotate=utils.arrangeSameValueEvent(h.eventLayers[0].rotate),h.eventLayers[0].alpha=utils.arrangeSameValueEvent(h.eventLayers[0].alpha),h.calcFloorPosition(),o.notesAbove.forEach((u,m)=>{u.judgeline=h,u.id=m,u.bpm=o.bpm,u.isAbove=!0,d.push(u)}),o.notesBelow.forEach((u,m)=>{u.judgeline=h,u.id=m,u.bpm=o.bpm,u.isAbove=!1,d.push(u)}),d.sort((u,m)=>u.time-m.time),d.forEach((u,m)=>{n[u.time]=n[u.time]?n[u.time]+1:1,u.id=m}),s.push(...d),t.judgelines.push(h)}),s.sort((o,l)=>o.time-l.time),s.forEach(o=>{n[o.time]>1&&(o.isMulti=!0),t.notes.push(a(o))}),t.notes.sort((o,l)=>o.time-l.time),s.sort((o,l)=>o.time-l.time),s.forEach(o=>{r.length<=0?r.push({startTime:o.time,endTime:o.time,bpm:o.bpm,holdBetween:(-1.2891*o.bpm+396.71)/1e3}):(r[r.length-1].endTime=o.time,r[r.length-1].bpm!=o.bpm&&r.push({startTime:o.time,endTime:o.time,bpm:o.bpm,holdBetween:(-1.2891*o.bpm+396.71)/1e3}))}),r.sort((o,l)=>o.startTime-l.startTime),r.length>0?(r[0].startTime=-999,r[r.length-1].endTime=1e4):r.push({startTime:-999,endTime:1e4,bpm:120,holdBetween:.242018}),t.bpmList=r.slice(),t;function a(o){o.time=calcRealTime(o.time,o.bpm),o.holdTime=calcRealTime(o.holdTime,o.bpm),o.holdEndTime=o.time+o.holdTime;{let l=o.judgeline.getFloorPosition(o.time);o.floorPosition=l?l.floorPosition+l.value*(o.time-l.startTime):0,o.type==3?(o.judgeline.getFloorPosition(o.holdEndTime),o.holdLength=o.holdTime*o.speed):o.holdLength=0}return new Note({id:o.id,lineId:o.lineId,type:o.type,time:o.time,holdTime:o.holdTime,holdLength:o.holdLength,positionX:o.positionX,floorPosition:o.floorPosition,speed:o.speed,isAbove:o.isAbove,isMulti:o.isMulti,useOfficialSpeed:!0,judgeline:o.judgeline})}}function convertOfficialVersion(e){let t=JSON.parse(JSON.stringify(e));switch(t.formatVersion){case 1:{t.formatVersion=3;for(const i of t.judgeLineList){let s=0;for(const n of i.speedEvents)n.startTime<0&&(n.startTime=0),n.floorPosition=s,s+=(n.endTime-n.startTime)*n.value/i.bpm*1.875;for(const n of i.judgeLineDisappearEvents)n.start2=0,n.end2=0;for(const n of i.judgeLineMoveEvents)n.start2=n.start%1e3/520,n.end2=n.end%1e3/520,n.start=parseInt(n.start/1e3)/880,n.end=parseInt(n.end/1e3)/880;for(const n of i.judgeLineRotateEvents)n.start2=0,n.end2=0}}case 3:break;default:throw new Error("Unsupported chart version: "+t.formatVersion)}return t}function calcRealTime(e,t){return e/t*1.875}const Easing$2=[e=>e,e=>Math.sin(e*Math.PI/2),e=>1-Math.cos(e*Math.PI/2),e=>1-(e-1)**2,e=>e**2,e=>(1-Math.cos(e*Math.PI))/2,e=>((e*=2)<1?e**2:-((e-2)**2-2))/2,e=>1+(e-1)**3,e=>e**3,e=>1-(e-1)**4,e=>e**4,e=>((e*=2)<1?e**3:(e-2)**3+2)/2,e=>((e*=2)<1?e**4:-((e-2)**4-2))/2,e=>1+(e-1)**5,e=>e**5,e=>1-2**(-10*e),e=>2**(10*(e-1)),e=>Math.sqrt(1-(e-1)**2),e=>1-Math.sqrt(1-e**2),e=>(2.70158*e-1)*(e-1)**2+1,e=>(2.70158*e-1.70158)*e**2,e=>((e*=2)<1?1-Math.sqrt(1-e**2):Math.sqrt(1-(e-2)**2)+1)/2,e=>e<.5?(14.379638*e-5.189819)*e**2:(14.379638*e-9.189819)*(e-1)**2+1,e=>1-2**(-10*e)*Math.cos(e*Math.PI/.15),e=>2**(10*(e-1))*Math.cos((e-1)*Math.PI/.15),e=>((e*=11)<4?e**2:e<8?(e-6)**2+12:e<10?(e-9)**2+15:(e-10.5)**2+15.75)/16,e=>1-Easing$2[25](1-e),e=>(e*=2)<1?Easing$2[25](e)/2:Easing$2[26](e-1)/2+.5,e=>e<.5?2**(20*e-11)*Math.sin((160*e+1)*Math.PI/18):1-2**(9-20*e)*Math.sin((160*e+1)*Math.PI/18)];function PhiEditChartConverter(e){let t=e.split(/\r\n|\n\r/),i=new Chart,s={bpm:[],judgelines:[],_judgelines:{},notes:[],notesPerLine:{},sameTimeNoteCount:{},pushNote:function(n){this.sameTimeNoteCount[floorNum(n.startTime)]=this.sameTimeNoteCount[floorNum(n.startTime)]?this.sameTimeNoteCount[floorNum(n.startTime)]+1:1,this.notesPerLine[n.lineId]||(this.notesPerLine[n.lineId]=[]),this.notesPerLine[n.lineId].push(n),this.notes.push(n)},pushEventToLine:function(n,r,a){if(isNaN(n)||n<0){console.warn("Invalid line id: "+n+", ignored");return}if(this._judgelines[n]||(this._judgelines[n]=new Judgeline({id:n})),this._judgelines[n].eventLayers.length<1&&this._judgelines[n].eventLayers.push(new EventLayer),!this._judgelines[n].eventLayers[0][r])throw new Error("No such event type: "+r);let o=this._judgelines[n].eventLayers[0][r],l=o[o.length-1];l&&l.startTime==a.startTime&&(isNaN(l.endTime)&&isNaN(a.endTime)||!isNaN(l.endTime)&&!isNaN(a.endTime)&&l.endTime==a.endTime)?(l.endTime=a.endTime,isNaN(parseFloat(a.value))?(l.start=a.start,l.end=a.end):l.value=a.value):o.push(a)}};if(!isNaN(t[0]))i.offset=parseFloat((parseFloat(t.shift())/1e3).toFixed(4))-.175;else return null;t.forEach((n,r)=>{if(!n||n==""||n.replace(/\s/g,"")=="")return;let a=n.split(" ");for(let o=1;o<a.length;o++)a[o]=parseFloat(a[o]);switch(a[0]){case"bp":{s.bpm.push({startBeat:a[1]||0,bpm:a[2]||120});break}case"n1":{s.pushNote({type:1,lineId:isNaN(a[1])?-1:a[1],startTime:a[2]||0,positionX:a[3]||0,isAbove:a[4]==1,isFake:a[5]==1});break}case"n2":{s.pushNote({type:3,lineId:isNaN(a[1])?-1:a[1],startTime:a[2]||0,endTime:a[3]||a[2]||0,positionX:a[4]||0,isAbove:a[5]==1,isFake:a[6]==1});break}case"n3":{s.pushNote({type:4,lineId:isNaN(a[1])?-1:a[1],startTime:a[2]||0,positionX:a[3]||0,isAbove:a[4]==1,isFake:a[5]==1});break}case"n4":{s.pushNote({type:2,lineId:isNaN(a[1])?-1:a[1],startTime:a[2]||0,positionX:a[3]||0,isAbove:a[4]==1,isFake:a[5]==1});break}case"#":{s.notes[s.notes.length-1].speed=isNaN(a[1])?1:a[1];break}case"&":{s.notes[s.notes.length-1].xScale=isNaN(a[1])?1:a[1];break}case"cv":{s.pushEventToLine(a[1],"speed",{startTime:a[2]||0,endTime:NaN,value:isNaN(a[3])?1:a[3]/7});break}case"cm":{s.pushEventToLine(a[1],"moveX",{startTime:a[2]||0,endTime:a[3]||a[2]||0,start:NaN,end:a[4]/2048-.5||0,easingType:a[6]||1}),s.pushEventToLine(a[1],"moveY",{startTime:a[2]||0,endTime:a[3]||a[2]||0,start:NaN,end:a[5]/1400-.5||0,easingType:a[6]||1});break}case"cp":{s.pushEventToLine(a[1],"moveX",{startTime:a[2]||0,endTime:NaN,start:a[3]/2048-.5||0,end:a[3]/2048-.5||0,easingType:1}),s.pushEventToLine(a[1],"moveY",{startTime:a[2]||0,endTime:NaN,start:a[4]/1400-.5||0,end:a[4]/1400-.5||0,easingType:1});break}case"cr":{s.pushEventToLine(a[1],"rotate",{startTime:a[2]||0,endTime:a[3]||a[2]||0,start:NaN,end:a[4]||0,easingType:a[5]||1});break}case"cd":{s.pushEventToLine(a[1],"rotate",{startTime:a[2]||0,endTime:NaN,start:a[3]||0,end:a[3]||0,easingType:1});break}case"cf":{s.pushEventToLine(a[1],"alpha",{startTime:a[2]||0,endTime:a[3]||a[2]||0,start:NaN,end:a[4]||0,easingType:1});break}case"ca":{s.pushEventToLine(a[1],"alpha",{startTime:a[2]||0,endTime:NaN,start:a[3]||0,end:a[3]||0,easingType:1});break}default:console.warn("Unsupported command: "+a[0]+`, ignoring.
At line `+(r+2)+`:
`+a.join(" "))}}),s.bpm.length<=0&&s.bpm.push({startBeat:0,endBeat:1e4,bpm:120}),s.bpm.sort((n,r)=>n.startBeat-r.startBeat);{let n=.5,r=0,a=0;s.bpm.forEach((o,l)=>{o.endBeat=s.bpm[l+1]?s.bpm[l+1].startBeat:1e4,a+=n*(o.startBeat-r),o.startTime=a,o.endTime=n*(o.endBeat-r),r+=o.startBeat-r,n=60/o.bpm,o.beatTime=60/o.bpm})}s.bpm.sort((n,r)=>r.startBeat-n.startBeat);for(const n in s.notesPerLine)s.notesPerLine[n].sort((r,a)=>r.startTime-a.startTime);for(const n in s._judgelines){let r=s._judgelines[n];r.sortEvent(),r.eventLayers[0].alpha.forEach((a,o,l)=>{isNaN(a.endTime)&&(a.endTime=o<l.length-1?l[o+1].startTime:1e5),isNaN(a.start)&&(a.start=o>0?l[o-1].end:0)}),r.eventLayers[0].moveX.forEach((a,o,l)=>{isNaN(a.endTime)&&(a.endTime=o<l.length-1?l[o+1].startTime:1e5),isNaN(a.start)&&(a.start=o>0?l[o-1].end:0)}),r.eventLayers[0].moveY.forEach((a,o,l)=>{isNaN(a.endTime)&&(a.endTime=o<l.length-1?l[o+1].startTime:1e5),isNaN(a.start)&&(a.start=o>0?l[o-1].end:0)}),r.eventLayers[0].rotate.forEach((a,o,l)=>{isNaN(a.endTime)&&(a.endTime=o<l.length-1?l[o+1].startTime:1e5),isNaN(a.start)&&(a.start=o>0?l[o-1].end/(Math.PI/180):0),a.start=a.start*(Math.PI/180),a.end=a.end*(Math.PI/180)}),r.eventLayers[0].speed.forEach((a,o,l)=>{isNaN(a.endTime)&&(a.endTime=o<l.length-1?l[o+1].startTime:1e5)}),r.eventLayers[0].alpha.forEach(a=>{let o=!0;if(a.start==-1)a.start=-255;else if(a.start==-2)a.start=-510;else if(a.start<-100&&a.start>=-1e3){for(let l=0,h=Math.ceil((a.endTime-a.startTime)/utils.CalcBetweenTime);l<h;l++){let c=a.startTime+l*utils.CalcBetweenTime>=a.endTime?a.endTime:a.startTime+l*utils.CalcBetweenTime,d=utils.valueCalculator(a,Easing$2,c),u=(d+100)*-1/10;if(d>=-100)break;for(const m of s.notesPerLine[n])if(!(m.startTime<c)){if(m.startTime>c)break;m.visibleBeat=u,o=!1}}a.start=o?-255:0}a.end==-1?a.end=-255:a.end==-2?a.end=-510:a.end<-100&&(a.end=o?-255:0),a.start=a.start/255,a.end=a.end/255});for(const a in r.eventLayers[0]){if(a=="speed"||!(r.eventLayers[0][a]instanceof Array))continue;let o=[];r.eventLayers[0][a].forEach(l=>{utils.calculateEventEase(l,Easing$2).forEach(h=>{o.push(h)})}),r.eventLayers[0][a]=o}for(const a in r.eventLayers[0])r.eventLayers[0][a]instanceof Array&&(r.eventLayers[0][a]=utils.calculateRealTime(s.bpm,r.eventLayers[0][a]));r.sortEvent(),r.calcFloorPosition()}for(const n in s.notesPerLine){let r=s.notesPerLine[n];r.forEach(a=>{s.sameTimeNoteCount[floorNum(a.startTime)]>1&&(a.isMulti=!0)}),r=calculateRealVisibleTime(s.bpm,r),r=utils.calculateRealTime(s.bpm,r),r.sort((a,o)=>a.startTime-o.startTime),r.forEach((a,o)=>{let l=s._judgelines[a.lineId];if(!l){console.warn("Judgeline "+a.lineId+" doesn't exist, ignoring.");return}{let h=l.getFloorPosition(a.startTime);if(a.floorPosition=h?h.floorPosition+h.value*(a.startTime-h.startTime):0,a.type==3){let c=l.getFloorPosition(a.endTime);a.holdLength=(c?c.floorPosition+c.value*(a.endTime-c.startTime):0)-a.floorPosition}else a.holdLength=0}i.notes.push(new Note({id:o,type:a.type,time:a.startTime,holdTime:a.endTime-a.startTime,speed:a.speed,isAbove:a.isAbove,isMulti:a.isMulti,isFake:a.isFake,positionX:a.positionX*9/1024,floorPosition:a.floorPosition,holdLength:a.holdLength,xScale:a.xScale,visibleTime:a.visibleTime,judgeline:l}))})}for(const n in s._judgelines)i.judgelines.push(s._judgelines[n]);return i.judgelines.sort((n,r)=>n.id-r.id),i.notes.sort((n,r)=>n.time-r.time),i.bpmList=utils.calculateHoldBetween(s.bpm),i}function floorNum(e){return Math.floor(e*8)}function calculateRealVisibleTime(e,t){let i=e.slice(),s=t.slice();return s.forEach(n=>{if(n.visibleBeat)for(let r=0,a=i.length;r<a;r++){let o=i[r];if(!(o.startBeat>n.visibleBeat)){n.visibleTime=n.visibleBeat*o.beatTime;break}}}),s}const calcBetweenTime=.125,Easing$1=[e=>e,e=>Math.sin(e*Math.PI/2),e=>1-Math.cos(e*Math.PI/2),e=>1-(1-e)*(1-e),e=>e*e,e=>-(Math.cos(Math.PI*e)-1)/2,e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,e=>1-Math.pow(1-e,3),e=>e*e*e,e=>1-Math.pow(1-e,4),e=>e*e*e*e,e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2,e=>1-Math.pow(1-e,5),e=>e*e*e*e*e,e=>e===1?1:1-Math.pow(2,-10*e),e=>e===0?0:Math.pow(2,10*e-10),e=>Math.sqrt(1-Math.pow(e-1,2)),e=>1-Math.sqrt(1-Math.pow(e,2)),e=>1+2.70158*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),e=>2.70158*e*e*e-1.70158*e*e,e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2,e=>e<.5?Math.pow(2*e,2)*((2.59491+1)*2*e-2.59491)/2:(Math.pow(2*e-2,2)*((2.59491+1)*(e*2-2)+2.59491)+2)/2,e=>e===0?0:e===1?1:Math.pow(2,-10*e)*Math.sin((e*10-.75)*(2*Math.PI/3))+1,e=>e===0?0:e===1?1:-Math.pow(2,10*e-10)*Math.sin((e*10-10.75)*(2*Math.PI/3)),e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,e=>1-Easing$1[25](1-e),e=>e<.5?(1-Easing$1[25](1-2*e))/2:(1+Easing$1[25](2*e-1))/2];function RePhiEditChartConverter(e){let t=[],i={},s=convertChartFormat(e),n=new Chart({name:s.META.name,artist:s.META.composer,author:s.META.charter,difficult:s.META.level,offset:s.META.offset/1e3});{let r=.5,a=0,o=0;s.BPMList.forEach((l,h)=>{l.endTime=s.BPMList[h+1]?s.BPMList[h+1].startTime:[1e4,0,1],l.startBeat=l.startTime[0]+l.startTime[1]/l.startTime[2],l.endBeat=l.endTime[0]+l.endTime[1]/l.endTime[2],o+=r*(l.startBeat-a),l.startTime=o,l.endTime=r*(l.endBeat-a),a+=l.startBeat-a,r=60/l.bpm,l.beatTime=60/l.bpm}),s.BPMList.sort((l,h)=>h.startBeat-l.startBeat)}return s.judgeLineList.forEach((r,a)=>{let o=new Judgeline({id:a,texture:r.Texture!="line.png"?r.Texture:null,parentLine:r.father>=0?r.father:NaN,zIndex:r.zOrder!=0?r.zOrder:NaN,isCover:r.isCover==1});if(r.attachUI&&r.attachUI!=""){console.warn("Line "+a+` is using 'attachUI' feature, ignored this line.
Please note that all notes on this line will also be ignored.`);return}if(r.eventLayers.forEach(l=>{let h=new EventLayer;for(const c in l)l[c]=utils.calculateEventsBeat(l[c]?l[c]:[]),c!="speedEvents"?l[c].forEach(d=>{utils.calculateEventEase(d,Easing$1).forEach(u=>{switch(c){case"moveXEvents":{h.moveX.push(u);break}case"moveYEvents":{h.moveY.push(u);break}case"alphaEvents":{h.alpha.push(u);break}case"rotateEvents":{h.rotate.push(u);break}default:console.warn("Unsupported event name '"+c+"', ignoring")}})}):l.speedEvents.forEach(d=>{separateSpeedEvent(d).forEach(u=>{h.speed.push(u)})});if(h.sort(),!(h.speed.length<=0&&h.moveX.length<=0&&h.moveY.length<=0&&h.alpha.length<=0&&h.rotate.length<=0)){for(const c in h)h[c]instanceof Array&&(h[c]=utils.calculateRealTime(s.BPMList,h[c]));h.speed.forEach(c=>{c.value=c.value/(.6/(120/900))}),h.moveX.forEach(c=>{c.start=c.start/1350,c.end=c.end/1350}),h.moveY.forEach(c=>{c.start=c.start/900,c.end=c.end/900}),h.alpha.forEach(c=>{c.start=c.start/255,c.end=c.end/255,c.start=c.start>1?1:c.start,c.end=c.end>1?1:c.end,c.start=c.start<-1?-1:c.start,c.end=c.end<-1?-1:c.end}),h.rotate.forEach(c=>{c.start=Math.PI/180*c.start,c.end=Math.PI/180*c.end}),h.sort(),o.eventLayers.push(h)}}),r.extended&&(r.extended.textEvents&&r.extended.textEvents.length>0&&(o.isText=!0,utils.calculateEventsBeat(r.extended.textEvents).forEach(l=>{calculateTextEventEase(l).forEach(h=>{o.extendEvent.text.push(h)})}),o.extendEvent.text.forEach((l,h)=>{isNaN(l.endTime)&&(l.endTime=o.extendEvent.text[h+1]?o.extendEvent.text[h+1].startTime:100)}),o.extendEvent.text=utils.calculateRealTime(s.BPMList,o.extendEvent.text)),r.extended.scaleXEvents&&r.extended.scaleXEvents.length>0&&(utils.calculateEventsBeat(r.extended.scaleXEvents).forEach(l=>{utils.calculateEventEase(l,Easing$1).forEach(h=>{o.extendEvent.scaleX.push(h)})}),o.extendEvent.scaleX=utils.calculateRealTime(s.BPMList,o.extendEvent.scaleX)),r.extended.scaleYEvents&&r.extended.scaleYEvents.length>0&&(utils.calculateEventsBeat(r.extended.scaleYEvents).forEach(l=>{utils.calculateEventEase(l,Easing$1).forEach(h=>{o.extendEvent.scaleY.push(h)})}),o.extendEvent.scaleY=utils.calculateRealTime(s.BPMList,o.extendEvent.scaleY)),r.extended.colorEvents&&r.extended.colorEvents.length>0&&(utils.calculateEventsBeat(r.extended.colorEvents).forEach(l=>{calculateColorEventEase(l).forEach(h=>{o.extendEvent.color.push(h)})}),o.extendEvent.color=utils.calculateRealTime(s.BPMList,o.extendEvent.color)),r.extended.inclineEvents&&r.extended.inclineEvents.length>0)){let l=utils.calculateEventsBeat(r.extended.inclineEvents);l.length==1&&l[0].startTime==0&&l[0].endTime==1&&l[0].start==0&&l[0].end==0||(l.forEach(h=>{utils.calculateEventEase(h,Easing$1).forEach(c=>{c.start=Math.PI/180*c.start,c.end=Math.PI/180*c.end,o.extendEvent.incline.push(c)})}),o.extendEvent.incline=utils.calculateRealTime(s.BPMList,o.extendEvent.incline))}o.noteControls.alpha=calculateNoteControls(r.alphaControl,"alpha",1),o.noteControls.scale=calculateNoteControls(r.sizeControl,"size",1),o.noteControls.x=calculateNoteControls(r.posControl,"pos",1),o.sortEvent(),o.calcFloorPosition(),r.notes=utils.calculateEventsBeat(r.notes?r.notes:[]),r.notes.sort((l,h)=>l.startTime-h.startTime),r.notes.forEach((l,h)=>{i[l.startTime]=i[l.startTime]?i[l.startTime]+1:1,l.id=h,l.judgeline=o,t.push(l)}),n.judgelines.push(o)}),t.forEach(r=>{i[r.startTime]>1&&(r.isMulti=!0)}),t=utils.calculateRealTime(s.BPMList,t),t.forEach(r=>{let a=r.judgeline.getFloorPosition(r.startTime);if(r.floorPosition=a?a.floorPosition+a.value*(r.startTime-a.startTime):0,r.type==2){let o=r.judgeline.getFloorPosition(r.endTime);r.holdLength=(o?o.floorPosition+o.value*(r.endTime-o.startTime):0)-r.floorPosition}else r.holdLength=0;n.notes.push(new Note({id:r.id,type:r.type==1?1:r.type==2?3:r.type==3?4:r.type==4?2:1,time:r.startTime,holdTime:r.endTime-r.startTime,speed:r.speed,floorPosition:r.floorPosition,holdLength:r.holdLength,positionX:r.positionX/(670*(9/80)),basicAlpha:r.alpha/255,visibleTime:r.visibleTime<999999?r.visibleTime:NaN,yOffset:r.yOffset/900,xScale:r.size,isAbove:r.above==1,isMulti:r.isMulti,isFake:r.isFake==1,judgeline:r.judgeline}))}),n.judgelines.sort((r,a)=>r.id-a.id),n.notes.sort((r,a)=>r.time-a.time),n.judgelines.forEach((r,a,o)=>{if(!isNaN(r.parentLine)&&r.parentLine>=0){let l=r.parentLine;r.parentLine=null;for(const h of o)if(h.id==l){r.parentLine=h;break}}else r.parentLine=null}),n.bpmList=utils.calculateHoldBetween(s.BPMList),n}function convertChartFormat(e){let t=JSON.parse(JSON.stringify(e));return t.META.RPEVersion<=100&&t.judgeLineList.forEach(i=>{i.bpmfactor=1,i.father=-1,i.zOrder=0,i.eventLayers.forEach(s=>{for(const n in s)s[n].forEach(r=>{r.easingLeft=0,r.easingRight=1})})}),t.META.RPEVersion<=105,t.META.RPEVersion<=113,t.META.RPEVersion<=123,t.META.RPEVersion>123&&console.warn("Unsupported chart version: "+t.META.RPEVersion+", some features may not supported"),t}function calculateTextEventEase(e){const t=calcBetweenTime/2,i=/(.+)%P%/,s=i.test(e.start)&&i.test(e.end),n=e.endTime-e.startTime;let r=[];if(!e)return[];if(s){const a=Number(e.start.match(i)[1])||0,o=Number(e.end.match(i)[1])||0,l=Math.round(a)===a&&Math.round(o)===o;for(let h=0,c=Math.ceil(n/t);h<c;h++){let d=e.startTime+h*t,u=e.startTime+(h+1)*t<=e.endTime?e.startTime+(h+1)*t:e.endTime,m=(u-e.startTime)/n,f=a*(1-m)+o*m;if(l&&(f=Math.round(f)),r[r.length-1]&&r[r.length-1].value==f){r[r.length-1].endTime=u;continue}r.push({startTime:d,endTime:u,value:f+""})}}else if(e.start!=e.end){const a=e.start.length<=e.end.length?e.start:e.end,o=e.start.length<=e.end.length?e.end:e.start;if(a==""||o.indexOf(a)===0){let h=[],c=-1;for(let d=0,u=Math.ceil(n/t);d<u;d++){let m=e.startTime+d*t,f=e.startTime+(d+1)*t<=e.endTime?e.startTime+(d+1)*t:e.endTime,p=Math.floor(_valueCalculator(e,f,a.length,o.length-1));if(c+1<p)for(let g=c+1;g<p;g++)h.push(o[g]);else c+1>p&&(h.length=p);if(o[p]&&h.push(o[p]),r[r.length-1]&&r[r.length-1].value==h.join("")){r[r.length-1].endTime=f;continue}if(f==e.endTime){r.push({startTime:m,endTime:f,value:e.end});break}r.push({startTime:m,endTime:f,value:h.join("")}),c=p}}else r.push({startTime:e.startTime,endTime:e.endTime,value:e.start}),r.push({startTime:e.endTime,endTime:NaN,value:e.end})}else r.push({startTime:e.startTime,endTime:e.endTime,value:e.start});return r}function calculateColorEventEase(e){let t=e.endTime-e.startTime,i=[];if(!e)return[];if(e.start[0]!=e.end[0]||e.start[1]!=e.end[1]||e.start[2]!=e.end[2])for(let s=0,n=Math.ceil(t/calcBetweenTime);s<n;s++){let r=e.startTime+s*calcBetweenTime,a=e.startTime+(s+1)*calcBetweenTime<=e.endTime?e.startTime+(s+1)*calcBetweenTime:e.endTime;i.push({startTime:r,endTime:a,value:new Color([Math.round(_valueCalculator(e,a,e.start[0],e.end[0]))/255,Math.round(_valueCalculator(e,a,e.start[1],e.end[1]))/255,Math.round(_valueCalculator(e,a,e.start[2],e.end[2]))/255]).toArray()})}else i.push({startTime:e.startTime,endTime:e.endTime,value:new Color([e.start[0]/255,e.start[1]/255,e.start[2]/255]).toArray()});return i}function calculateNoteControls(e,t="alpha",i=1){if(!e||!(e instanceof Array)||e.length<=0)return[];if(e.length==2&&e[0].x==0&&e[1].x>=1e4&&e[0][t]==i&&e[1][t]==i)return[];let s=e.slice().sort((o,l)=>l.x-o.x),n=[];for(let o=0;o<s.length;o++){const l=s[o],h=s[o+1];n=[...n,...a(l,h,t)]}return n=r(n),n[0].y<1e4&&n.unshift({_y:9999999/900,y:9999999,value:n[0].value}),n;function r(o){let l=[];for(const h of o)l.length>0&&l[l.length-1].value==h.value||l.push(h);return l.slice()}function a(o,l=null,h="alpha"){let c=[],d=o.x-(l?l.x:0),u=o[h]-(l?l[h]:o[h]),m=Easing$1[o.easing-1],f=o.x;if(o[h]==(l?l[h]:o[h]))return[{_y:o.x/900,y:o.x,value:o[h]}];for(;f>(l?l.x:0);){let p=(o.x-f)/d,g=parseFloat((o[h]-u*m(p)).toFixed(2));c.length>0&&parseFloat(c[c.length-1].value.toFixed(2))==g?(c[c.length-1]._y=f/900,c[c.length-1].y=f):c.push({_y:f/900,y:f,value:g}),f-=2}return c[c.length-1].value!=(l?l[h]:o[h])&&c.push({_y:(l?l.x:0)/900,y:l?l.x:0,value:l?l[h]:o[h]}),c}}function separateSpeedEvent(e){let t=[],i=e.endTime-e.startTime;if(e.start!=e.end)for(let s=0,n=Math.ceil(i/calcBetweenTime);s<n;s++){let r=e.startTime+s*calcBetweenTime,a=e.startTime+(s+1)*calcBetweenTime<=e.endTime?e.startTime+(s+1)*calcBetweenTime:e.endTime;t.push({startTime:r,endTime:a,value:utils.valueCalculator(e,Easing$1,a)})}else t.push({startTime:e.startTime,endTime:e.endTime,value:e.start});return t}function _valueCalculator(e,t,i=0,s=1){if(i==s)return i;if(e.startTime>t)throw new Error("currentTime must bigger than startTime");if(e.endTime<t)throw new Error("currentTime must smaller than endTime");let n=(t-e.startTime)/(e.endTime-e.startTime),r=1-n,a=Easing$1[e.easingType-1]?Easing$1[e.easingType-1]:Easing$1[0],o=a(number(e.easingLeft,0,0,1)*r+number(e.easingRight,1,0,1)*n),l=a(number(e.easingLeft,0,0,1)),h=a(number(e.easingRight,1,0,1));return o=(o-l)/(h-l),i*(1-o)+s*o}class Chart{constructor(t={}){this.judgelines=[],this.notes=[],this.bpmList=[],this.offset=number(t.offset,0),this.isLineTextureReaded=!1,this.music=t.music?t.music:null,this.bg=t.bg?t.bg:null,this.info={name:t.name,artist:t.artist,author:t.author,bgAuthor:t.bgAuthor,difficult:t.difficult,md5:t.md5},this.sprites={}}static from(t,i={},s=[]){let n,r=i,a;if(typeof t=="object"){isNaN(Number(t.formatVersion))?t.META&&!isNaN(Number(t.META.RPEVersion))&&(n=RePhiEditChartConverter(t),r=n.info):n=OfficialChartConverter(t);try{a=md5Hash(JSON.stringify(t))}catch(o){console.warn("Failed to calculate chart MD5."),console.error(o),a=null}}else if(typeof t=="string"){n=PhiEditChartConverter(t);try{a=md5Hash(t)}catch(o){console.warn("Failed to calculate chart MD5."),console.error(o),a=null}}if(!n)throw new Error("Unsupported chart format");return n.info={name:r.name,artist:r.artist,author:r.author,bgAuthor:r.bgAuthor,difficult:r.difficult,md5:a},n.judgelines.forEach(o=>{o.eventLayers.forEach(l=>{l.moveX=arrangeLineEvents(l.moveX),l.moveY=arrangeLineEvents(l.moveY),l.rotate=arrangeLineEvents(l.rotate),l.alpha=arrangeLineEvents(l.alpha)});for(const l in o.extendEvent)l!=="color"&&l!=="text"?o.extendEvent[l]=arrangeLineEvents(o.extendEvent[l]):o.extendEvent[l]=arrangeSingleValueLineEvents(o.extendEvent[l]);o.sortEvent()}),n.readLineTextureInfo(s),n.judgelines.sort((o,l)=>o.parentLine&&l.parentLine?o.parentLine.id-l.parentLine.id:o.parentLine?1:l.parentLine?-1:o.id-l.id),n}readLineTextureInfo(t=[]){if(this.isLineTextureReaded||t.length<=0)return;let i=!1;t.forEach(s=>{this.judgelines[s.LineId]&&(this.judgelines[s.LineId].texture=s.Image,this.judgelines[s.LineId].useOfficialScale=!0,this.judgelines[s.LineId].scaleX=isNaN(s.Horz)?1:parseFloat(s.Horz),this.judgelines[s.LineId].scaleY=isNaN(s.Vert)?1:parseFloat(s.Vert),this.judgelines[s.LineId].extendEvent.scaleX.push({startTime:-999,endTime:1e3,start:this.judgelines[s.LineId].scaleX,end:this.judgelines[s.LineId].scaleX}),this.judgelines[s.LineId].extendEvent.scaleY.push({startTime:-999,endTime:1e3,start:this.judgelines[s.LineId].scaleY,end:this.judgelines[s.LineId].scaleY}),i=!0)}),i&&(this.isLineTextureReaded=!0)}createSprites(t,i,s,n=null,r={},a=1,o=.5,l=!0,h=!1){let c=[];if(this.bg){this.sprites.bg=new Sprite(this.bg);let d=new Graphics;d.beginFill(0),d.drawRect(0,0,this.sprites.bg.texture.width,this.sprites.bg.texture.height),d.endFill(),d.position.x=-this.sprites.bg.width/2,d.position.y=-this.sprites.bg.height/2,d.alpha=o,this.sprites.bg.addChild(d),this.sprites.bg.anchor.set(.5),this.sprites.bg.cover=d,t.addChild(this.sprites.bg)}this.judgelines.forEach((d,u)=>{if(d.createSprite(s,r,h),d.sprite.position.x=i.width/2,d.sprite.position.y=i.height/2,d.sprite.zIndex=10+u,isNaN(d.zIndex)||c.push(d),t.addChild(d.sprite),d.debugSprite&&(d.debugSprite.zIndex=999+d.sprite.zIndex,t.addChild(d.debugSprite)),d.texture&&d.useOfficialScale){let m=d.extendEvent.scaleY[0].start;d.extendEvent.scaleY[0].start=d.extendEvent.scaleY[0].end=1080/d.sprite.texture.height*(m*(m<0?-1:1)),d.extendEvent.scaleX[0].start=d.extendEvent.scaleX[0].end=d.extendEvent.scaleY[0].start*d.extendEvent.scaleX[0].start,d.useOfficialScale=!1}}),c.sort((d,u)=>d.zIndex-u.zIndex),c.forEach((d,u)=>{d.sprite.zIndex=10+this.judgelines.length+u,d.debugSprite&&(d.debugSprite.zIndex=999+d.sprite.zIndex)}),this.notes.forEach((d,u)=>{d.createSprite(s,r,l,h),d.sprite.zIndex=10+(this.judgelines.length+c.length)+(d.type===3?u:u+10),t.addChild(d.sprite),d.debugSprite&&(d.debugSprite.zIndex=999+d.sprite.zIndex,t.addChild(d.debugSprite))}),this.sprites.info={},this.sprites.info.songName=new Text((this.info.name||"Untitled")+(Math.round(a*100)!==100?" (x"+a.toFixed(2)+")":""),{fontFamily:"A-OTF Shin Go Pr6N H",fill:16777215}),this.sprites.info.songName.anchor.set(0,1),this.sprites.info.songName.zIndex=99999,n?n.addChild(this.sprites.info.songName):t.addChild(this.sprites.info.songName),this.sprites.info.songDiff=new Text(this.info.difficult||"SP Lv.?",{fontFamily:"MiSans",fill:16777215}),this.sprites.info.songDiff.anchor.set(0,1),this.sprites.info.songDiff.zIndex=99999,n?n.addChild(this.sprites.info.songDiff):t.addChild(this.sprites.info.songDiff)}resizeSprites(t,i){if(this.renderSize=t,this.sprites.bg){let s=this.renderSize.width/this.sprites.bg.texture.width,n=this.renderSize.height/this.sprites.bg.texture.height,r=s>n?s:n;this.sprites.bg.scale.set(r),this.sprites.bg.position.set(this.renderSize.width/2,this.renderSize.height/2)}this.judgelines&&this.judgelines.length>0&&this.judgelines.forEach(s=>{if(s.sprite){s.isText?(s.sprite.style.fontSize=68*this.renderSize.heightPercent,s.baseScaleX=s.baseScaleY=1):s.texture?s.baseScaleX=s.baseScaleY=this.renderSize.heightPercent:(s.baseScaleX=4e3/s.sprite.texture.width*(this.renderSize.width/1350),s.baseScaleY=this.renderSize.lineScale*18.75*.008/s.sprite.texture.height),s.sprite.scale.set(s.scaleX*s.baseScaleX,s.scaleY*s.baseScaleY),s.sprite.position.x=s.x*this.renderSize.width,s.sprite.position.y=s.y*this.renderSize.height;for(const n in s.noteControls)for(const r of s.noteControls[n])r.y=r._y*t.height;i&&(s.sprite.alpha=0),s.debugSprite&&s.debugSprite.scale.set(this.renderSize.heightPercent)}}),this.notes&&this.notes.length>0&&this.notes.forEach(s=>{if(s.type===3){let n=s.holdLength*(s.useOfficialSpeed?1:s.speed)*this.renderSize.noteSpeed/this.renderSize.noteScale;s.sprite.children[1].height=n,s.sprite.children[2].position.y=-n}s.sprite.baseScale=this.renderSize.noteScale,s.sprite.scale.set(this.renderSize.noteScale*s.xScale,this.renderSize.noteScale),i&&(s.sprite.alpha=0),s.debugSprite&&s.debugSprite.scale.set(this.renderSize.heightPercent)}),this.sprites.info.songName.style.fontSize=t.heightPercent*27,this.sprites.info.songName.position.x=t.heightPercent*57,this.sprites.info.songName.position.y=t.height-t.heightPercent*66,this.sprites.info.songDiff.style.fontSize=t.heightPercent*20,this.sprites.info.songDiff.position.x=t.heightPercent*57,this.sprites.info.songDiff.position.y=t.height-t.heightPercent*42}reset(){this.holdBetween=this.bpmList[0].holdBetween,this.judgelines.forEach(t=>{t.reset()}),this.notes.forEach(t=>{t.reset()})}destroySprites(){this.judgelines.forEach(t=>{t.sprite&&(t.reset(),t.sprite.destroy(),t.sprite=void 0,t.debugSprite&&(t.debugSprite.destroy(!0),t.debugSprite=void 0))}),this.notes.forEach(t=>{t.sprite&&(t.reset(),t.sprite.destroy(),t.sprite=void 0,t.debugSprite&&(t.debugSprite.destroy(!0),t.debugSprite=void 0))}),this.sprites.bg&&(this.sprites.bg.destroy(),this.sprites.bg=void 0),this.sprites.info.songName.destroy(),this.sprites.info.songName=void 0,this.sprites.info.songDiff.destroy(),this.sprites.info.songDiff=void 0,this.sprites.info=void 0}get totalNotes(){return this.notes.length}get totalRealNotes(){let t=0;return this.notes.forEach(i=>{i.isFake||t++}),t}get totalFakeNotes(){let t=0;return this.notes.forEach(i=>{i.isFake&&t++}),t}}function arrangeLineEvents(e){let t=e.slice(),i=[],s=[{startTime:-99,endTime:0,start:t[0]?t[0].start:0,end:t[0]?t[0].start:0}];if(e.length<=0)return[];t.push({startTime:0,endTime:1e3,start:t[t.length-1]?t[t.length-1].end:0,end:t[t.length-1]?t[t.length-1].end:0});for(let n of t){let r=s[s.length-1];if(n.endTime<n.startTime){let a=n.endTime,o=n.startTime;n.startTime=a,n.endTime=o}r.endTime<n.startTime?s.push({startTime:r.endTime,endTime:n.startTime,start:r.end,end:r.end},n):r.endTime==n.startTime?s.push(n):r.endTime>n.startTime&&r.endTime<n.endTime&&s.push({startTime:r.endTime,endTime:n.endTime,start:n.start+(n.end-n.start)*((r.endTime-n.startTime)/(n.endTime-n.startTime))+(r.end-n.start),end:n.end})}i=[s.shift()];for(let n of s){let r=i[i.length-1],a=r.endTime-r.startTime,o=n.endTime-n.startTime;n.startTime==n.endTime||(r.end==n.start&&(r.end-r.start)*o==(n.end-n.start)*a?(i[i.length-1].endTime=n.endTime,i[i.length-1].end=n.end):i.push(n))}return s.slice()}function arrangeSingleValueLineEvents(e){let t=e.slice(),i=[t.shift()];if(e.length<=0)return[];for(let s of t){let n=i[i.length-1];if(s.endTime<s.startTime){let r=s.endTime,a=s.startTime;s.startTime=r,s.endTime=a}n.value==s.value?n.endTime=s.endTime:((n.endTime<s.startTime||n.endTime>s.startTime)&&(n.endTime=s.startTime),i.push(s))}return i.slice()}function unmuteAudio(e){const t=e.createGain(),i=e.createOscillator();i.frequency.value=440,i.start(e.currentTime+.1),i.stop(e.currentTime+.1),t.connect(e.destination),t.disconnect(),e.resume().catch(s=>{console.info("[WAudio] Failed to resume AudioContext",s)})}class Clock{constructor(t){unmuteAudio(t),this.time=0,this._audioCtx=t,this._offsets=[],this._sum=0,this.update()}update(){const t=performance.now()/1e3,i=t-this._audioCtx.currentTime;for(this._offsets.push(i),this._sum+=i;this._offsets.length>60;)this._sum-=this._offsets.shift();this.time=t-this._sum/this._offsets.length}}class AudioTimer{constructor(t,i=0,s=1){this.startTime=NaN,this.pausedTime=NaN,this.status=3,this._clock=new Clock(t),this._offset=number(i)/1e3,this._speed=number(s),this._lastSpeedChangedProgress=0}now(){return this._clock.time-this._offset}start(){this.status===2?this.startTime=this.now()-(this.pausedTime-this.startTime):this.startTime=this.now(),this.status=1,this.pausedTime=NaN}pause(){this.status===1?(this.pausedTime=this.now(),this.status=2):this.status===2&&(this.startTime=this.now()-(this.pausedTime-this.startTime),this.pausedTime=NaN,this.status=1)}stop(){this.status!==3&&(this.startTime=NaN,this.pausedTime=NaN,this._lastSpeedChangedProgress=0,this.status=3)}seek(t){this.status!==3&&(this.startTime-=t,isNaN(this.pausedTime)&&this.now()-(this.startTime-this._lastSpeedChangedProgress)<0?this.startTime=this.now():!isNaN(this.pausedTime)&&this.startTime>this.pausedTime&&(this.startTime=this.pausedTime))}get speed(){return this._speed}set speed(t){this.status!==3&&(this._lastSpeedChangedProgress+=((this.status===1?this.now():this.pausedTime)-this.startTime)*this._speed),this.startTime=this.now(),this.status===2&&(this.pausedTime=this.now()),this._speed=number(t)}get time(){return this._clock.update(),(isNaN(this.pausedTime)?this.now()-this.startTime:this.pausedTime-this.startTime)*this._speed+this._lastSpeedChangedProgress}static get TimerDiff(){return AudioContextTimerDiff}}const GlobalAudioCtxConfig={latencyHint:"interactive"},AudioCtx=window.AudioContext||window.webkitAudioContext,GlobalAudioCtx=new Audio().canPlayType("audio/ogg")==""?new oggmentedAudioContext(GlobalAudioCtxConfig):new AudioCtx(GlobalAudioCtxConfig);GlobalAudioCtx.addEventListener("statechange",()=>{GlobalAudioCtx.state==="running"&&(console.log("[WAudio] Resume AudioContext success"),window.removeEventListener("mousedown",ResumeGlobalAudioContext),window.removeEventListener("touchstart",ResumeGlobalAudioContext))});class WAudio{constructor(t,i=!1,s=0,n=1,r=1,a=void 0){this.source=t,this.loop=i,this.onend=a,this._offset=number(s,0),this._volume=number(n,1),this._speed=number(r,1),this._gain=GlobalAudioCtx.createGain(),this._gain.gain.value=this._volume,this._gain.connect(GlobalAudioCtx.destination)}static from(t,i){return new Promise(async(s,n)=>{try{let{startOffset:r,buffer:a}=parseAudio(t),o=await GlobalAudioCtx.decodeAudioData(a||t);o||n("Unsupported source type");let l=new WAudio(o,i,r);s(l)}catch(r){n(r)}})}reset(){this._buffer&&(this._buffer.onended=void 0,this._buffer.stop(),this._buffer.disconnect(),this._buffer=null),this._timer&&(this._timer.stop(),this._timer=null)}play(t=!1){t&&!this._timer&&(this._timer=new AudioTimer(GlobalAudioCtx,this._offset,this._speed)),this._buffer=GlobalAudioCtx.createBufferSource(),this._buffer.buffer=this.source,this._buffer.loop=this.loop,this._buffer.connect(this._gain),this._gain.gain.value=this._volume,this._buffer.playbackRate.value=this._speed,this._timer?(this._timer.speed=this._speed,this._buffer.start(0,this._timer.status!==3&&this._timer.time>0?this._timer.time:0),this._timer.start(GlobalAudioCtx.currentTime)):this._buffer.start(0,0),this._buffer.onended=()=>{this._timer&&this._timer.stop(),this.onend instanceof Function&&this.onend()}}pause(){this._timer&&this._timer.pause(),this._buffer&&(this._buffer.onended=void 0,this._buffer.stop())}stop(){this.pause(),this._timer&&this._timer.stop()}seek(t){if(!this._timer)return;let i=!1;this._timer.status!==3&&(this._timer.status===1&&(i=!0,this._buffer.onended=void 0,this._buffer.stop()),this._timer.seek(t),i&&this.play())}get isPaused(){return this._timer.status===2}get isStoped(){return this._timer.status===3}get duration(){return this.source.duration}get currentTime(){return this._timer?this._timer.time:NaN}get progress(){return this.currentTime/this.source.duration}get volume(){return this._volume}set volume(t){this._volume=number(t,1),this._buffer&&(this._gain.gain.value=this._volume)}get speed(){return this._speed}set speed(t){this._speed=number(t,1),this._timer&&(this._timer.speed=this._speed),this._buffer&&(this._buffer.playbackRate.value=this._speed)}static get AudioContext(){return GlobalAudioCtx}static get globalLatency(){return(isNaN(GlobalAudioCtx.baseLatency)?0:GlobalAudioCtx.baseLatency)+(isNaN(GlobalAudioCtx.outputLatency)?0:GlobalAudioCtx.outputLatency)}}function parseAudio(e){if(!detectIfIsMp3(e))return{startOffset:19};let t=Mp3Parser.readTags(new DataView(e));if(t.length===3&&t[1]._section.type==="Xing"){let i=new Uint8Array(e.byteLength-t[1]._section.byteLength),s=t[1]._section.offset+t[1]._section.byteLength;return i.set(new Uint8Array(e,0,t[1]._section.offset),0),i.set(new Uint8Array(e,s,e.byteLength-s),t[0]._section.offset),{startOffset:predictMp3Offset(t),buffer:i.buffer}}return{startOffset:predictMp3Offset(t)}}function detectIfIsMp3(e){const t=[[73,68,51],[255,251,80]];let i=new Uint8Array(e);for(const s of t)if(i[0]===s[0]&&i[1]===s[1]&&i[2]===s[2])return!0;return!1}function predictMp3Offset(e){const t=a=>console.warn("Cannot predict MP3 offset:",a);if(!e||!e.length)return t("MP3 tags not found"),22;const s=e[e.length-1];let n,r;if(s._section.sampleLength!=1152)return t("Unexpected sample length"),22;for(const a of e)a._section.type==="Xing"&&(n=a);return n?n.identifier?!n.vbrinfo||n.vbrinfo.ENC_DELAY!==576?(t("vbr ENC_DELAY value unexpected"),22):(r=n.header.samplingRate,r===32e3?89-1152e3/r:r===44100||r===48e3?68-1152e3/r:(t("sampleRate unexpected"),22)):(t("vbr tag identifier missing"),22):22}window.addEventListener("load",()=>{GlobalAudioCtx.state!=="running"&&(window.addEventListener("mousedown",ResumeGlobalAudioContext),window.addEventListener("touchstart",ResumeGlobalAudioContext))});function ResumeGlobalAudioContext(){console.log("[WAudio] Trying resume AudioContext..."),unmuteAudio(GlobalAudioCtx)}const Easing=[e=>e,e=>Math.sin(e*Math.PI/2),e=>1-Math.cos(e*Math.PI/2),e=>1-(1-e)*(1-e),e=>e*e,e=>-(Math.cos(Math.PI*e)-1)/2,e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2,e=>1-Math.pow(1-e,3),e=>e*e*e,e=>1-Math.pow(1-e,4),e=>e*e*e*e,e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2,e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2,e=>1-Math.pow(1-e,5),e=>e*e*e*e*e,e=>e===1?1:1-Math.pow(2,-10*e),e=>e===0?0:Math.pow(2,10*e-10),e=>Math.sqrt(1-Math.pow(e-1,2)),e=>1-Math.sqrt(1-Math.pow(e,2)),e=>1+2.70158*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),e=>2.70158*e*e*e-1.70158*e*e,e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2,e=>e<.5?Math.pow(2*e,2)*((2.59491+1)*2*e-2.59491)/2:(Math.pow(2*e-2,2)*((2.59491+1)*(e*2-2)+2.59491)+2)/2,e=>e===0?0:e===1?1:Math.pow(2,-10*e)*Math.sin((e*10-.75)*(2*Math.PI/3))+1,e=>e===0?0:e===1?1:-Math.pow(2,10*e-10)*Math.sin((e*10-10.75)*(2*Math.PI/3)),e=>e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375,e=>1-Easing[25](1-e),e=>e<.5?(1-Easing[25](1-2*e))/2:(1+Easing[25](2*e-1))/2];function PrprEffectReader(e){let t=[],i=[...e.effects],s=[...e.bpm];{let n=.5,r=0,a=0;s.forEach((o,l)=>{o.endTime=s[l+1]?s[l+1].time:[1e4,0,1],o.startBeat=o.time[0]+o.time[1]/o.time[2],o.endBeat=o.endTime[0]+o.endTime[1]/o.endTime[2],a+=n*(o.startBeat-r),o.startTime=a,o.endTime=n*(o.endBeat-r),r+=o.beat-r,n=60/o.bpm,o.beatTime=60/o.bpm}),s.sort((o,l)=>l.beat-o.beat)}return s.length<=0&&s.push({startBeat:0,endBeat:1e4,startTime:0,endTime:999999,bpm:120,beatTime:.5}),utils.calculateRealTime(s,calculateEffectsBeat(i)).forEach(n=>{let r=new Effect({startTime:n.startTime,endTime:n.endTime,shader:n.shader,isGlobal:n.global||!1,vars:{}});for(const a in n.vars){let o=n.vars[a];if(o instanceof Array){let l=[],h=[];utils.calculateEventsBeat(o).sort((c,d)=>c.startTime-d.startTime||d.endTime-c.startTime).forEach((c,d,u)=>{let m=u[d-1];m&&c.startTime==m.startTime?c.endTime>=m.endTime&&(l[l.length-1]=c):l.push(c)});for(const c of l)h.push(...utils.calculateRealTime(s,utils.calculateEventEase(c,Easing)));h.sort((c,d)=>c.startTime-d.startTime||d.endTime-c.startTime),r.vars[a]=h}else r.vars[a]=o}t.push(r)}),t.sort((n,r)=>n.startTime-r.startTime),t}function calculateEffectBeat(e){return e.startTime=parseFloat((e.start[0]+e.start[1]/e.start[2]).toFixed(3)),e.endTime=parseFloat((e.end[0]+e.end[1]/e.end[2]).toFixed(3)),e}function calculateEffectsBeat(e){return e.forEach(t=>{t=calculateEffectBeat(t)}),e}class Effect{constructor(t){this.shader=t.shader,this.startTime=t.startTime,this.endTime=t.endTime,this.isGlobal=bool(t.isGlobal,!1),this.vars={},this.reset()}reset(){this._currentValue=this.shader!==null&&typeof this.shader!="string"?this.shader.defaultValues:{}}static from(t){let i;if(typeof t=="object"&&(i=PrprEffectReader(t)),!i||i.length<=0)throw new Error("Unsupported file format");return i}calcTime(t,i){if(this.shader===null)return;const{vars:s,shader:n,_currentValue:r}=this;for(const a in s){const o=s[a];typeof o=="object"?r[a]=valueCalculator(o,t,n.defaultValues[a]):r[a]=o}n.update({...r,time:t,screenSize:i})}}function valueCalculator(e,t,i){for(let s=0,n=e.length;s<n;s++){const r=e[s];if(r.endTime<t)continue;if(r.startTime>t)break;if(r.start===r.end)return r.start;let a=(t-r.startTime)/(r.endTime-r.startTime),o=1-a;return r.start*o+r.end*a}return i}const chromatic=`#version 100
// Adapted from https://godotshaders.com/shader/chromatic-abberation/
precision mediump float;

varying lowp vec2 uv;
uniform sampler2D screenTexture;

uniform float sampleCount; // %3% int 1..64
uniform float power; // %0.01%

vec3 chromatic_slice(float t) {
  vec3 res = vec3(1.0 - t, 1.0 - abs(t - 1.0), t - 1.0);
  return max(res, 0.0);
}

void main() {
  vec3 sum = vec3(0.0);
  vec3 c = vec3(0.0);
  vec2 offset = (uv - vec2(0.5)) * vec2(1, -1);
  int sample_count = int(sampleCount);
  for (int i = 0; i < 64; ++i) {
    if (i >= sample_count) break;
    float t = 2.0 * float(i) / float(sample_count - 1); // range 0.0->2.0
    vec3 slice = vec3(1.0 - t, 1.0 - abs(t - 1.0), t - 1.0);
    slice = max(slice, 0.0);
    sum += slice;
    vec2 slice_offset = (t - 1.0) * power * offset;
    c += slice * texture2D(screenTexture, uv + slice_offset).rgb;
  }
  gl_FragColor.rgb = c / sum;
}
`,circle_blur=`#version 100
// Adapted from https://godotshaders.com/shader/artsy-circle-blur-type-thingy/
precision mediump float;

varying lowp vec2 uv;
uniform vec2 screenSize;
uniform sampler2D screenTexture;

uniform float size; // %10.0%

void main() {
  vec4 c = texture2D(screenTexture, uv);
  float length = dot(c, c);
  vec2 pixel_size = 1.0 / screenSize;
  for (float x = -size; x < size; x++) {
    for (float y = -size; y < size; ++y) {
      if (x * x + y * y > size * size) continue;
      vec4 new_c = texture2D(screenTexture, uv + pixel_size * vec2(x, y));
      float new_length = dot(new_c, new_c);
      if (new_length > length) {
        length = new_length;
        c = new_c;
      }
    }
  }
  gl_FragColor = c;
}
`,fisheye=`#version 100
// Adapted from https://www.shadertoy.com/view/4s2GRR
precision mediump float;

varying lowp vec2 uv;
uniform vec2 screenSize;
uniform sampler2D screenTexture;

uniform float power; // %-0.1%

void main() {
  vec2 p = vec2(uv.x, uv.y * screenSize.y / screenSize.x);
  float aspect = screenSize.x / screenSize.y;
  vec2 m = vec2(0.5, 0.5 / aspect);
  vec2 d = p - m;
  float r = sqrt(dot(d, d));

  float new_power = (2.0 * 3.141592 / (2.0 * sqrt(dot(m, m)))) * power;

  float bind = new_power > 0.0? sqrt(dot(m, m)): (aspect < 1.0? m.x: m.y);

  vec2 nuv;
  if (new_power > 0.0)
    nuv = m + normalize(d) * tan(r * new_power) * bind / tan(bind * new_power);
  else
    nuv = m + normalize(d) * atan(r * -new_power * 10.0) * bind / atan(-new_power * bind * 10.0);

  gl_FragColor = texture2D(screenTexture, vec2(nuv.x, nuv.y * aspect));
}
`,glitch=`#version 100
// Adapted from https://godotshaders.com/shader/glitch-effect-shader/
precision highp float;

varying lowp vec2 uv;
uniform sampler2D screenTexture;
uniform float time;

uniform float power; // %0.03%
uniform float rate; // %0.6% 0..1
uniform float speed; // %5.0%
uniform float blockCount; // %30.5%
uniform float colorRate; // %0.01% 0..1

float my_trunc(float x) {
  return x < 0.0? -floor(-x): floor(x);
}

float random(float seed) {
  return fract(543.2543 * sin(dot(vec2(seed, seed), vec2(3525.46, -54.3415))));
}

void main() {
  float enable_shift = float(random(my_trunc(time * speed)) < rate);

  vec2 fixed_uv = uv;
  fixed_uv.x += (random((my_trunc(uv.y * blockCount) / blockCount) + time) - 0.5) * power * enable_shift;

  vec4 pixel_color = texture2D(screenTexture, fixed_uv);
  pixel_color.r = mix(
    pixel_color.r,
    texture2D(screenTexture, fixed_uv + vec2(colorRate, 0.0)).r,
    enable_shift
  );
  pixel_color.b = mix(
    pixel_color.b,
    texture2D(screenTexture, fixed_uv + vec2(-colorRate, 0.0)).b,
    enable_shift
  );
  gl_FragColor = pixel_color;
}
`,grayscale=`# version 100
// Adapted from https://www.shadertoy.com/view/lsdXDH
precision mediump float;

varying lowp vec2 uv;
uniform sampler2D screenTexture;

uniform float factor; // %1.0% 0..1

void main() {
  vec3 color = texture2D(screenTexture, uv).xyz;
  vec3 lum = vec3(0.299, 0.587, 0.114);
  vec3 gray = vec3(dot(lum, color));
  gl_FragColor = vec4(mix(color, gray, factor), 1.0);
}
`,noise=`#version 100
// Adapted from https://godotshaders.com/shader/screen-noise-effect-shader/
precision mediump float;

varying lowp vec2 uv;
uniform sampler2D screenTexture;

uniform float seed; // %81.0%
uniform float power; // %0.03% 0..1

vec2 random(vec2 pos) {
  return fract(sin(vec2(dot(pos, vec2(12.9898,78.233)), dot(pos, vec2(-148.998,-65.233)))) * 43758.5453);
}

void main() {
  vec2 new_uv = uv + (random(uv + vec2(seed, 0.0)) - vec2(0.5, 0.5)) * power;
  gl_FragColor = texture2D(screenTexture, new_uv);
}
`,pixel=`// #version 100
// Adapted from https://godotshaders.com/shader/pixelate-2/
precision mediump float;

varying lowp vec2 uv;
uniform vec2 screenSize;
uniform sampler2D screenTexture;

uniform float size; // %10.0%

void main() {
  vec2 factor = screenSize / size;
  float x = floor(uv.x * factor.x + 0.5) / factor.x;
  float y = floor(uv.y * factor.y + 0.5) / factor.y;
  gl_FragColor = texture2D(screenTexture, vec2(x, y));
}`,radial_blur=`#version 100
// Adapted from https://godotshaders.com/shader/radical-blur-shader/
precision mediump float;

varying lowp vec2 uv;
uniform sampler2D screenTexture;

uniform float centerX; // %0.5% 0..1
uniform float centerY; // %0.5% 0..1
uniform float power; // %0.01% 0..1
uniform float sampleCount; // %6% int 1..64

void main() {
  vec2 direction = uv - vec2(centerX, centerY);
  vec3 c = vec3(0.0);
  float f = 1.0 / sampleCount;
  vec2 screen_uv = uv / 2.0 + vec2(0.5, 0.5);
  for (float i = 0.0; i < 64.0; ++i) {
    if (i >= sampleCount) break;
    c += texture2D(screenTexture, uv - power * direction * i).rgb * f;
  }
  gl_FragColor.rgb = c;
}
`,shockwave=`#version 100
// Adapted from https://www.shadertoy.com/view/llj3Dz
precision mediump float;

varying lowp vec2 uv;
uniform vec2 screenSize;
uniform sampler2D screenTexture;

uniform float progress; // %0.2% 0..1
uniform float centerX; // %0.5% 0..1
uniform float centerY; // %0.5% 0..1
uniform float width; // %0.1%
uniform float distortion; // %0.8%
uniform float expand; // %10.0%

void main() {
  float aspect = screenSize.y / screenSize.x;

  vec2 center = vec2(centerX, centerY);
  center.y = (center.y - 0.5) * aspect + 0.5;

  vec2 tex_coord = uv;
    tex_coord.y = (tex_coord.y - 0.5) * aspect + 0.5;
  float dist = distance(tex_coord, center);

  if (progress - width <= dist && dist <= progress + width) {
    float diff = dist - progress;
    float scale_diff = 1.0 - pow(abs(diff * expand), distortion);
    float dt = diff * scale_diff;

    vec2 dir = normalize(tex_coord - center);

    tex_coord += ((dir * dt) / (progress * dist * 40.0));
    gl_FragColor = texture2D(screenTexture, vec2(tex_coord.x, (tex_coord.y - 0.5) / aspect + 0.5));

    gl_FragColor += (gl_FragColor * scale_diff) / (progress * dist * 40.0);
  } else {
    gl_FragColor = texture2D(screenTexture, vec2(tex_coord.x, (tex_coord.y - 0.5) / aspect + 0.5));
  }
}`,vignette=`#version 100
// Adapted from https://www.shadertoy.com/view/lsKSWR
precision mediump float;

varying lowp vec2 uv;
uniform vec2 screenSize;
uniform sampler2D screenTexture;

uniform vec4 color; // %0.0, 0.0, 0.0, 1.0%
uniform float extend; // %0.25% 0..1
uniform float radius; // %15.0%

void main() {
  vec2 new_uv = uv * (1.0 - uv.yx);
  float vig = new_uv.x * new_uv.y * radius;
  vig = pow(vig, extend);
  gl_FragColor = mix(color, texture2D(screenTexture, uv), vig);
}
`,presets=Object.freeze(Object.defineProperty({__proto__:null,chromatic,circleBlur:circle_blur,fisheye,glitch,grayscale,noise,pixel,radialBlur:radial_blur,shockwave,vignette},Symbol.toStringTag,{value:"Module"})),defaultValueReg=/uniform\s+(\w+)\s+(\w+);\s+\/\/\s+%([^%]+)%/g;class Shader extends Filter{constructor(t,i){const s="// "+t.replaceAll("uv","vTextureCoord").replaceAll("screenTexture","uSampler"),n={};let r={time:0,screenSize:[0,0],UVScale:[0,0]};[...s.matchAll(defaultValueReg)].map(a=>{const o=a[1],l=a[2],h=a[3];switch(o){case"float":{n[l]=parseFloat(h);break}case"vec2":case"vec4":{n[l]=h.split(",").map(c=>parseFloat(c.trim()));break}default:throw Error("Unknown type: "+typeName)}}),r={...n,...r},super(null,s,r);for(const a in r)this.uniforms[a]=r[a];this.defaultValues=n,this.name=i}static from(t,i){const n=document.createElement("canvas").getContext("webgl");if(!n)throw"Your browser doesn't support WebGL.";n.clearColor(0,0,0,1),n.clear(n.COLOR_BUFFER_BIT);const r=n.createShader(n.FRAGMENT_SHADER);if(n.shaderSource(r,t),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS))throw`An error occurred compiling the shaders.
${n.getShaderInfoLog(r)}`;return new Shader(t,i)}static get presets(){return presets}update(t){for(const i in t)this.uniforms[i]=t[i]}}const doms$1={linkInput:document.querySelector("input#phizone-chart-link"),chartDownload:document.querySelector("button#phizone-download-chart"),downloadProgress:document.querySelector("div#phizone-download-progress")},PhiZoneLinkReg=/^https:\/\/[\d\w]+\.phi\.zone\/charts\/(\d+)/;doms$1.linkInput.addEventListener("keydown",e=>{e.key==="Enter"&&doms$1.chartDownload.dispatchEvent(new Event("click"))});doms$1.chartDownload.addEventListener("click",()=>{let e=doms$1.linkInput.value;if(!e||e==""){alert("Please enter a chart link/ID!"),doms$1.linkInput.focus();return}if(PhiZoneLinkReg.test(e)?e=parseInt(PhiZoneLinkReg.exec(e)[1]):e=parseInt(e),isNaN(e)||e<=0){alert("Please enter a valid chart link/ID!"),doms$1.linkInput.focus();return}doms$1.downloadProgress.innerText="Getting chart info...",fetch("https://api.phi.zone/charts/"+e+"/?query_song=1&query_owner=1").then(t=>t.json()).then(t=>{let i={},s={};if(t.id!==e){doms$1.downloadProgress.innerText="Cannot get chart info: "+t.detail;return}if(!text(t.chart,null)||!t.song||!text(t.song.illustration,null)||!text(t.song.song,null)){doms$1.downloadProgress.innerText="Cannot get chart info: server didn't provide any link";return}i={chart:t.chart,song:t.song.song,illustration:t.song.illustration},s={name:t.song.name,artist:t.song.composer,author:t.charter.replace(/\[PZUser:\d+:(.+)\]/,"$1"),bgAuthor:t.song.illustrator,difficult:"Lv."+t.level+" "+Math.floor(t.difficulty)},downloadFiles(i,s)})});async function downloadFiles(e,t){let i={chart:e.chart.split("/"),song:e.song.split("/"),bg:e.illustration.split("/")};i.chart=decodeURIComponent(i.chart[i.chart.length-1]),i.song=decodeURIComponent(i.song[i.song.length-1]),i.bg=decodeURIComponent(i.bg[i.bg.length-1]);let s=`Name: ${t.name}\r
Level: ${t.difficult}\r
Charter: ${t.author}\r
Chart: ${i.chart}\r
Song: ${i.song}\r
Picture: ${i.bg}`,n=await o(e.chart,l=>{doms$1.downloadProgress.innerText="Downloading chart ("+Math.floor(l*100)+"%)"}),r=await o(e.song,l=>{doms$1.downloadProgress.innerText="Downloading song ("+Math.floor(l*100)+"%)"}),a=await o(e.illustration,l=>{doms$1.downloadProgress.innerText="Downloading bg ("+Math.floor(l*100)+"%)"});doms$1.downloadProgress.innerText="All files are downloaded, head to 'File' to select chart.",loadChartFiles([new File([n],i.chart,{type:n.type,lastModified:Date.now()}),new File([r],i.song,{type:r.type,lastModified:Date.now()}),new File([a],i.bg,{type:a.type,lastModified:Date.now()}),new File([new Blob([s])],"Settings.txt",{type:"text/plain",lastModified:Date.now()})]);function o(l,h){return new Promise((c,d)=>{let u=new XMLHttpRequest;u.responseType="blob",u.onreadystatechange=()=>{u.readyState===4&&u.status===200&&c(u.response)},u.onprogress=m=>{typeof h=="function"&&h(m.loaded/m.total)},u.onerror=m=>{d(m)},u.open("GET",l),u.send()})}}const qs=e=>document.querySelector(e);new FontFaceObserver("MiSans"),new FontFaceObserver("A-OTF Shin Go Pr6N H");function toggleSkipConfigElements(e){const i=document.querySelector(".file-select").children;for(let s=0;s<i.length;s++){const n=i[s];n.classList.contains("none-hide")||(e?n.classList.remove("skip-config-hide"):n.classList.add("skip-config-hide"))}}function getSearchString(e){let i=window.location.search.substring(1,window.location.search.length).split("&");if(i.length<=0)return null;for(const s of i)if(s.indexOf(e+"=")>=0){let n=s.replace(e+"=","");return decodeURIComponent(n)}return null}const doms={fileSelect:document.querySelector("div.file-select"),chartPackFile:document.querySelector("input#file-chart-pack"),chartPackFileReadProgress:document.querySelector("div#file-read-progress"),skinPackFile:document.querySelector("input#file-skin-pack"),skinPackFileReadProgress:document.querySelector("div#loading-skin-pack"),file:{chart:document.querySelector("select#file-chart"),music:document.querySelector("select#file-music"),bg:document.querySelector("select#file-bg")},settings:{showBG:document.querySelector("input#settings-show-bg"),multiNoteHL:document.querySelector("input#settings-multi-note-hl"),showAPStatus:document.querySelector("input#settings-show-ap-status"),showInputPoint:document.querySelector("input#settings-show-input-point"),noteScale:document.querySelector("input#settings-note-scale"),bgDim:document.querySelector("input#settings-bg-dim"),bgBlur:document.querySelector("input#settings-bg-blur"),bgQuality:document.querySelector("select#settings-bg-quality"),offset:document.querySelector("input#settings-audio-offset"),useBrowserLatency:document.querySelector("input#settings-use-browser-latency"),testInputDelay:document.querySelector("button#settings-test-input-delay"),speed:document.querySelector("input#settings-audio-speed"),hitsound:document.querySelector("input#settings-hitsound"),hitsoundVolume:document.querySelector("input#settings-hitsound-volume"),challengeMode:document.querySelector("input#settings-challenge-mode"),plyndb:document.querySelector("input#settings-plyndb"),autoPlay:document.querySelector("input#settings-autoplay"),antiAlias:document.querySelector("input#settings-anti-alias"),lowResolution:document.querySelector("input#settings-low-resolution"),debug:document.querySelector("input#settings-debug"),prprExtra:document.querySelector("input#settings-prpr-extra")},startBtn:document.querySelector("button#start"),loadingStatus:document.querySelector("div#loading-status"),fullscreenBtn:document.querySelector("button#fullscreen"),playResult:{container:document.querySelector("div.play-result"),scoreBar:document.querySelector("div.play-result .info-bar.score"),accBar:document.querySelector("div.play-result .info-bar.acc-bar")},errorWindow:{window:document.querySelector("div.error-window"),closeBtn:document.querySelector("div.error-window button.close"),content:document.querySelector("div.error-window code.content")},progressContainer:document.querySelector("#progress-container"),progressTemplate:document.querySelector("#progress-template"),progressTotal:document.querySelector("#progress-total"),progressdetail:document.querySelector("#progress-details")},files={charts:{},musics:{},images:{},infos:[],lines:[],shaders:{},all:{}},currentFile={chart:null,music:null,bg:null},assets={textures:{},sounds:{}};var GlobalGame;if(!doms.progressContainer){const e=document.createElement("div");e.id="progress-container",e.style.cssText=`
        position: fixed;
        top: 10px;
        right: 10px;
        width: 300px;
        max-height: 80vh;
        overflow-y: auto;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 10px;
        z-index: 1000;
        border-radius: 5px;
        display: none;
    `,document.body.appendChild(e),doms.progressContainer=e}class ProgressTracker{constructor(){this.trackers={},this.container=doms.progressContainer,this.template=doms.progressTemplate,this.detail=doms.progressdetail,this.total={element:doms.progressTotal,lastLoaded:0,lastTime:Date.now(),speed:0},this.totaldata=0,this.loaddata=0}addFile(t,i){const s=this.template.cloneNode(!0),n=document.createElement("div");n.appendChild(s);const r=n.firstElementChild;return r.id=`progress-${t}`,r.querySelector(".file-name").textContent=t,r.querySelector(".loaded").textContent="0B",r.querySelector(".total").textContent="0B",r.querySelector(".speed").textContent="0B/s",this.container.appendChild(r),this.trackers[t]={element:r,startTime:Date.now(),lastLoaded:0,lastTime:Date.now(),speed:0,total:0},this.trackers[t]}updateProgress(t,i,s){const n=this.trackers[t];if(!n)return;n.total===0&&s>0&&(this.totaldata+=s),n.total=s;const r=Date.now(),a=(r-n.lastTime)/1e3,o=i-n.lastLoaded;this.loaddata+=o,n.speed=o/a,n.lastLoaded=i,n.lastTime=r;const l=s>0?i/s*100:0;n.element.querySelector(".progress").style.width=`${l}%`,n.element.querySelector(".loaded").textContent=formatBytes(i),n.element.querySelector(".total").textContent=formatBytes(s),n.element.querySelector(".speed").textContent=`${formatBytes(isNaN(n.speed)?0:n.speed)}/s`,this.updateTotalProgress()}updateTotalProgress(){const t=Date.now(),i=(t-this.total.lastTime)/1e3,s=this.loaddata-this.total.lastLoaded;i>.5&&(this.total.speed=s/i,this.total.lastLoaded=this.loaddata,this.total.lastTime=t);const n=this.totaldata>0?this.loaddata/this.totaldata*100:0;this.total.element.querySelector(".progress").style.width=`${n}%`,this.total.element.querySelector(".loaded").textContent=formatBytes(this.loaddata),this.total.element.querySelector(".total").textContent=formatBytes(this.totaldata),this.total.element.querySelector(".speed").textContent=`${formatBytes(this.total.speed)}/s`}complete(t){const i=this.trackers[t];i&&(this.updateProgress(t,i.total,i.total),i.element.style.background="rgba(76, 175, 80, 0.2)")}all_complete(){setTimeout(()=>{const t=this.detail;t&&(t.open=!1)},500)}error(t){const i=this.trackers[t];i&&(i.element.style.background="rgba(244, 67, 54, 0.2)",i.element.querySelector(".progress").style.background="#f44336")}}function formatBytes(e,t=2){if(e===0)return"0B";const i=1024,s=t<0?0:t,n=["B","KB","MB","GB"],r=Math.floor(Math.log(e)/Math.log(i));return parseFloat((e/Math.pow(i,r)).toFixed(s))+n[r]}doms.chartPackFile.addEventListener("input",function(){this.files.length<=0||(console.log(this.files),loadChartFiles(this.files))});document.getElementById("load-url-btn").addEventListener("click",async()=>{const e=document.getElementById("chart-url-input").value;if(!e){alert("Please enter a URL");return}try{doms.chartPackFileReadProgress.innerText="Downloading file from URL...";const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const i=await t.blob(),s=e.split("/").pop()||"chart.zip",n=new File([i],s,{type:i.type,lastModified:new Date().getTime()});loadChartFiles([n])}catch(t){doms.chartPackFileReadProgress.innerText="Failed to download: "+t.message,console.error("URL load error:",t)}});document.getElementById("chart-url-input").addEventListener("keypress",e=>{e.key==="Enter"&&document.getElementById("load-url-btn").click()});doms.skinPackFile.addEventListener("input",function(){this.files.length<=0||!this.files[0]||JSZip.loadAsync(this.files[0],{createFolders:!1}).then(async e=>{let t=0;for(const i in e.files){let s=e.files[i];if(s.dir)continue;let n=s.name.split("."),r=n[n.length-1],a=new File([await s.async("blob")],i,{type:"",lastModified:s.date});a.format=r,await new Promise(()=>{throw new Error("Just make a promise, plz ignore me")}).catch(async()=>{let o=await createImageBitmap(a),l=await Texture.from(o),h=/^([a-zA-Z]+)\.[a-zA-Z]+$/.exec(a.name)[1];h=h.replace(h[0],h[0].toLowerCase()),!(h.toLowerCase()=="judgeline"||h.toLowerCase()=="pauseButton")&&assets.textures[h]&&(Texture.addToCache(l,h),assets.textures[h]=l,t++,doms.skinPackFileReadProgress.innerText="Load "+a.name+" successfully.")}).catch(async()=>{let o=await loadAudio(a,!1,!0);if(a.name.indexOf("Hitsound-")==0){let l=/^Hitsound\-([a-zA-Z]+)\.[a-zA-Z\d]+$/.exec(a.name)[1].toLowerCase();if(!assets.sounds[l])return;assets.sounds[l]=o,t++,doms.skinPackFileReadProgress.innerText="Load "+a.name+" successfully."}}).catch(o=>{})}if(!(assets.textures.clickRaw instanceof Array)){let i=[];for(let s=0;s<Math.floor(assets.textures.clickRaw.height/assets.textures.clickRaw.width);s++){let n=new Rectangle(0,s*assets.textures.clickRaw.width,assets.textures.clickRaw.width,assets.textures.clickRaw.width),r=new Texture(assets.textures.clickRaw.baseTexture,n);Texture.addToCache(r,"clickRaw"+(s+0)),r.defaultAnchor.set(.5),i.push(r)}assets.textures.clickRaw=i}doms.skinPackFileReadProgress.innerText="Successfully load "+t+" skin file(s)."}).catch(e=>{doms.skinPackFileReadProgress.innerText=this.files[0].name+" may not a vaild zip file.",console.error(e)})});doms.file.chart.addEventListener("input",function(){if(currentFile.chart=files.charts[this.value],files.infos&&files.infos.length>0){for(const e of files.infos)if(e.Chart===this.value){currentFile.music=files.musics[e.Music],currentFile.bg=files.images[e.Image],doms.file.music.value=e.Music,doms.file.bg.value=e.Image;break}}doms.file.music.dispatchEvent(new Event("input")),doms.file.bg.dispatchEvent(new Event("input"))});doms.file.music.addEventListener("input",function(){currentFile.music=files.musics[this.value]});doms.file.bg.addEventListener("input",function(){currentFile.bg=files.images[this.value]});doms.startBtn.addEventListener("click",async()=>{if(!currentFile.chart){alert("No chart selected.");return}if(!currentFile.music){alert("No music selected.");return}let e={...files.all};if(e["Tap.png"]||(e["Tap.png"]=assets.textures.tap),e["TapHL.png"]||(e["TapHL.png"]=assets.textures.tapHL),e["Drag.png"]||(e["Drag.png"]=assets.textures.drag),e["DragHL.png"]||(e["DragHL.png"]=assets.textures.dragHL),e["Flick.png"]||(e["Flick.png"]=assets.textures.flick),e["FlickHL.png"]||(e["FlickHL.png"]=assets.textures.flickHL),e["HoldHead.png"]||(e["HoldHead.png"]=assets.textures.holdHeadHL),e["HoldHeadHL.png"]||(e["HoldHeadHL.png"]=assets.textures.holdHeadHL),e["Hold.png"]||(e["Hold.png"]=assets.textures.holdBody),e["HoldHL.png"]||(e["HoldHL.png"]=assets.textures.holdBodyHL),e["HoldEnd.png"]||(e["HoldEnd.png"]=assets.textures.holdEnd),currentFile.chart.music=currentFile.music,currentFile.bg&&doms.settings.showBG.checked){let i=await Texture.from(await blurImage(await resizeImage(currentFile.bg,parseInt(doms.settings.bgQuality.value)),doms.settings.bgBlur.value));Texture.addToCache(i,doms.file.bg.value+"_blured"),currentFile.chart.bg=i}else currentFile.chart.bg=null;if(files.infos&&files.infos.length>0){for(const i of files.infos)if(i.Chart===doms.file.chart.value){currentFile.chart.info.name=i.Name,currentFile.chart.info.artist=i.Composer,currentFile.chart.info.author=i.Designer,currentFile.chart.info.bgAuthor=i.Illustrator,currentFile.chart.info.difficult=i.Level;break}}if(files.lines&&files.lines.length>0){let i=[];for(const s of files.lines)s.Chart===doms.file.chart.value&&i.push(s);currentFile.chart.readLineTextureInfo(i)}window.innerHeight>window.innerWidth&&alert("检测到您处于竖屏模式！这可能导致铺面比较奇怪，但如你所愿，游戏会继续进行。"),GlobalGame=new Game({chart:currentFile.chart,assets,effects:files.effects,zipFiles:e,render:{resizeTo:document.documentElement,resolution:doms.settings.lowResolution.checked?1:window.devicePixelRatio,antialias:doms.settings.antiAlias.checked},settings:{multiNoteHL:doms.settings.multiNoteHL.checked,showAPStatus:doms.settings.showAPStatus.checked,showInputPoint:doms.settings.showInputPoint.checked,bgDim:doms.settings.bgDim.value,noteScale:1e4-doms.settings.noteScale.value,audioOffset:doms.settings.offset.value/1e3+(doms.settings.useBrowserLatency.checked?WAudio.globalLatency:0),speed:doms.settings.speed.value,hitsound:doms.settings.hitsound.checked,hitsoundVolume:doms.settings.hitsoundVolume.value,challengeMode:doms.settings.challengeMode.checked,autoPlay:doms.settings.autoPlay.checked,debug:doms.settings.debug.checked,shader:doms.settings.prprExtra.checked},watermark:"github/MisaLiu/phi-chart-render v0.0.1-beta15-15eaf44"}),document.body.appendChild(GlobalGame.render.view),GlobalGame.render.view.classList.add("canvas-game"),GlobalGame.on("start",()=>console.log("Game started!")),GlobalGame.on("pause",()=>{console.log("Game paused!"),qs(".game-paused").style.display="block"}),GlobalGame.on("end",i=>{console.log("Game ended!"),showGameResultPopup(i)}),doms.settings.plyndb.checked&&GlobalGame.on("tick",PlayLikeYouNeverDidBefore),GlobalGame.createSprites(),GlobalGame.start(),doms.fileSelect.style.display="none"});doms.errorWindow.closeBtn.addEventListener("click",()=>{doms.errorWindow.window.style.display="none"});window.addEventListener("resize",()=>{calcHeightPercent()});document.addEventListener("DOMContentLoaded",()=>{window.addEventListener("load",async()=>{try{function isValidUrl(e){try{return new URL(e),!0}catch{return!1}}function requestFile(e,t,i){return new Promise((s,n)=>{let r=new XMLHttpRequest;r.responseType="blob",t.addFile(i,e),r.onprogress=a=>{a.lengthComputable&&t.updateProgress(i,a.loaded,a.total)},r.onload=()=>{r.status===200?(t.complete(i),s(r.response)):(t.error(i),n(new Error(`HTTP error! status: ${r.status}`)))},r.onerror=a=>{t.error(i),n(a)},r.open("GET",e),r.send()})}const progressTracker=new ProgressTracker,shouldSkipConfig=getSearchString("skip_config")==="true",urlParams=new URLSearchParams(window.location.search),chartUrlParam=urlParams.get("chart_url"),chartUrlInput=document.getElementById("chart-url-input");toggleSkipConfigElements(!1);const allResources=[{name:"tap",url:"./assets/Tap.png",type:"image"},{name:"tapHL",url:"./assets/TapHL.png",type:"image"},{name:"drag",url:"./assets/Drag.png",type:"image"},{name:"dragHL",url:"./assets/DragHL.png",type:"image"},{name:"flick",url:"./assets/Flick.png",type:"image"},{name:"flickHL",url:"./assets/FlickHL.png",type:"image"},{name:"holdHead",url:"./assets/HoldHead.png",type:"image"},{name:"holdHeadHL",url:"./assets/HoldHeadHL.png",type:"image"},{name:"holdBody",url:"./assets/Hold.png",type:"image"},{name:"holdBodyHL",url:"./assets/HoldHL.png",type:"image"},{name:"holdEnd",url:"./assets/HoldEnd.png",type:"image"},{name:"judgeline",url:"./assets/JudgeLine.png",type:"image"},{name:"clickRaw",url:"./assets/clickRaw128.png",type:"image"},{name:"pauseButton",url:"./assets/pauseButton.png",type:"image"},{name:"tap",url:"./assets/sounds/Hitsound-Tap.ogg",type:"sound",options:{loop:!1,noTimer:!0}},{name:"drag",url:"./assets/sounds/Hitsound-Drag.ogg",type:"sound",options:{loop:!1,noTimer:!0}},{name:"flick",url:"./assets/sounds/Hitsound-Flick.ogg",type:"sound",options:{loop:!1,noTimer:!0}},{name:"ez",url:"./assets/sounds/result/ez.ogg",type:"resultMusic",options:{loop:!0,noTimer:!0}},{name:"hd",url:"./assets/sounds/result/hd.ogg",type:"resultMusic",options:{loop:!0,noTimer:!0}},{name:"in",url:"./assets/sounds/result/in.ogg",type:"resultMusic",options:{loop:!0,noTimer:!0}},{name:"at",url:"./assets/sounds/result/at.ogg",type:"resultMusic",options:{loop:!0,noTimer:!0}},{name:"sp",url:"./assets/sounds/result/sp.ogg",type:"resultMusic",options:{loop:!0,noTimer:!0}},{name:"spGlitch",url:"./assets/sounds/result/sp_glitch.ogg",type:"resultMusic",options:{loop:!0,noTimer:!0}},{name:"MiSans",url:"./fonts/MiSans-Regular.ttf",type:"font"},{name:"A-OTF Shin Go Pr6N H",url:"./fonts/A-OTF_Shin_Go_Pr6N_H.ttf",type:"font"}],resourceLoadPromises=allResources.map(e=>(async()=>{try{doms.loadingStatus.innerText="Loading assets ...";const t=await requestFile(e.url,progressTracker,e.name+"("+e.type+")");switch(e.type){case"image":const i=await createImageBitmap(t),s=await Texture.from(i);if(Texture.addToCache(s,e.name),assets.textures[e.name]=s,e.name==="clickRaw"){const a=[];for(let o=0;o<Math.floor(s.height/s.width);o++){const l=new Rectangle(0,o*s.width,s.width,s.width),h=new Texture(s.baseTexture,l);Texture.addToCache(h,`${e.name}${o}`),h.defaultAnchor.set(.5),a.push(h)}assets.textures[e.name]=a}doms.loadingStatus.innerText=`Loaded ${e.type==="image"?"asset":e.type==="sound"?"hitsound":"result music"} ${e.name} ...`;break;case"sound":const n=await loadAudio(t,e.options.loop,e.options.noTimer);assets.sounds||(assets.sounds={}),assets.sounds[e.name]=n,doms.loadingStatus.innerText=`Loaded ${e.type==="image"?"asset":e.type==="sound"?"hitsound":"result music"} ${e.name} ...`;break;case"resultMusic":const r=await loadAudio(t,e.options.loop,e.options.noTimer);assets.sounds.result||(assets.sounds.result={}),assets.sounds.result[e.name]=r,doms.loadingStatus.innerText=`Loaded ${e.type==="image"?"asset":e.type==="sound"?"hitsound":"result music"} ${e.name} ...`;break;case"font":{try{const a=await t.arrayBuffer(),o=new FontFace(e.name,a);document.fonts.add(o),await o.load(null,3e4),console.log(`Font ${e.name} loaded successfully`),doms.loadingStatus.innerText=`Loaded font ${e.name} ...`}catch(a){console.error(`Failed to load font ${e.name}:`,a),doms.loadingStatus.innerText=`Failed to load font ${e.name}: ${a.message}`}break}}}catch(t){console.error(`Failed getting resource ${e.name}:`,t)}})());await Promise.all(resourceLoadPromises),progressTracker.all_complete(),document.body.classList.add("font-loaded"),doms.loadingStatus.innerText="All done!",doms.chartPackFileReadProgress.innerText="No chart pack file selected",doms.chartPackFile.disabled=!1,doms.skinPackFile.disabled=!1,calcHeightPercent();const waitForFilesLoaded=()=>new Promise(e=>{const t=setInterval(()=>{doms.file.chart.childNodes.length>0&&doms.file.music.childNodes.length>0&&(clearInterval(t),e())},100)});if(chartUrlParam)try{let e;try{if(e=atob(chartUrlParam),!isValidUrl(e))throw new Error("Decoded string is not a valid URL")}catch{e=chartUrlParam}chartUrlInput.value=e,doms.chartPackFileReadProgress.innerText="Loading chart from URL...";const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const i=await t.blob(),s=e.split("/").pop()||"chart.zip",n=new File([i],s,{type:i.type,lastModified:new Date().getTime()});await loadChartFiles([n]),await waitForFilesLoaded(),doms.chartPackFileReadProgress.innerText=`Loaded chart from ${e}`,shouldSkipConfig&&(console.log("skip_config enabled, starting game automatically"),doms.file.chart.childNodes.length>0&&doms.file.music.childNodes.length>0&&(doms.file.chart.value=doms.file.chart.options[0].value,doms.file.music.value=doms.file.music.options[0].value,doms.file.chart.dispatchEvent(new Event("input")),doms.file.music.dispatchEvent(new Event("input")),setTimeout(()=>{toggleSkipConfigElements(!0),doms.startBtn.click(),document.documentElement.requestFullscreen&&document.getElementById("fullscreen").click().catch(r=>console.error("Fullscreen error:",r))},500)))}catch(e){doms.chartPackFileReadProgress.innerText="Failed to load from URL: "+e.message,console.error("URL load error:",e)}document.getElementById("load-url-btn").addEventListener("click",async()=>{const e=chartUrlInput.value;if(!e){alert("Please enter a URL");return}try{doms.chartPackFileReadProgress.innerText="Downloading file from URL...";const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const i=await t.blob(),s=e.split("/").pop()||"chart.zip",n=new File([i],s,{type:i.type,lastModified:new Date().getTime()});loadChartFiles([n])}catch(t){doms.chartPackFileReadProgress.innerText="Failed to download: "+t.message,console.error("URL load error:",t)}}),toggleSkipConfigElements(!0),chartUrlInput.addEventListener("keypress",e=>{e.key==="Enter"&&document.getElementById("load-url-btn").click()}),doms.settings.testInputDelay.testTimes=0,doms.settings.testInputDelay.testDelays=0,doms.settings.testInputDelay.addEventListener("touchstart",e=>{let t=()=>performance?performance.now():Date.now();doms.settings.testInputDelay.testTimes+=1,doms.settings.testInputDelay.testDelays+=t()-e.timeStamp,doms.settings.testInputDelay.innerText="Tap on this button to test input delay..."+Math.round(doms.settings.testInputDelay.testDelays/doms.settings.testInputDelay.testTimes*1e3)/1e3+"ms"}),doms.playResult.scoreBar.addEventListener("click",()=>doms.playResult.accBar.classList.toggle("show"));{let e=document.querySelectorAll("div.tab div.bar > *"),t=document.querySelectorAll('div.tab div.content > *[id^="tab-"]');for(const i of e)i.addEventListener("click",switchTab);for(let i=0;i<t.length;i++){let s=t[i];i===0?s.style.display="block":s.style.display="none"}}fetch("https://www.googletagmanager.com/gtag/js?id=G-PW9YT2TVFV").then(e=>e.text()).then(res=>{eval(res),window.dataLayer=window.dataLayer||[],window.gtag=function(){dataLayer.push(arguments)},gtag("js",new Date),gtag("config","G-PW9YT2TVFV")}).catch(e=>{console.error("Failed to load Google Analytics"),console.error(e)}),initConsoleEasterEgg()}catch(e){alert(e.message)}})});function readArrayBuffer(e){return new Promise((t,i)=>{let s=new FileReader;s.onloadend=()=>{t(s.result)},s.onerror=n=>{i(n)},s.readAsArrayBuffer(e)})}function loadAudio(e,t=!1,i=!1){return new Promise(async(s,n)=>{try{let r=await readArrayBuffer(e),a=await WAudio.from(r,t,i);s(a)}catch(r){n(r)}})}function CsvReader(e){let t=[],i=[];return e.split(/[\r\n]+/).forEach((s,n)=>{s.split(",").forEach((r,a)=>{n<=0?t.push(/([A-Za-z0-9]+)/.exec(r)[1]):(i[n-1]||(i[n-1]={}),i[n-1][t[a]]=r)})}),i}function SettingsReader(e){let t=(e+"").split(/[\r\n]+/),i=/^([a-zA-Z]+):\s(.+)$/,s={};for(const n of t){let r=i.exec(n);if(!r||r.length<3)continue;let a=r[1],o=r[2];switch(a){case"Name":{s.Name=o;break}case"Level":{s.Level=o;break}case"Charter":{s.Designer=o;break}case"Chart":{s.Chart=o;break}case"Song":{s.Music=o;break}case"Picture":{s.Image=o;break}default:s[a]=o}}return s}function blurImage(e,t=10){let i=document.createElement("canvas"),s=i.getContext("2d"),n;return e.baseTexture?n=e.baseTexture.resource.source:n=e,i.width=n.width,i.height=n.height,s.drawImage(n,0,0),processCanvasRGB(i,0,0,n.width,n.height,t),new Promise((r,a)=>{createImageBitmap(i).then(o=>r(o)).catch(o=>a(o))})}function resizeImage(e,t=1){let i=document.createElement("canvas"),s,n=Pica({features:["all"]});switch(e.baseTexture?s=e.baseTexture.resource.source:s=e,t){case 0:{i.width=480,i.height=s.height*(480/s.width);break}case 1:{i.width=720,i.height=s.height*(720/s.width);break}case 2:{i.width=1080,i.height=s.height*(1080/s.width);break}default:i.width=s.width,i.height=s.height}return new Promise(async(r,a)=>{r(await createImageBitmap(await n.resize(s,i)))})}function calcHeightPercent(){let e=document.documentElement.clientHeight/9*16<document.documentElement.clientWidth?document.documentElement.clientHeight/9*16:document.documentElement.clientWidth;document.body.style.setProperty("--height-percent",document.documentElement.clientHeight/1080),document.body.style.setProperty("--width-offset",(document.documentElement.clientWidth-e)/2+"px")}function pauseGame(){GlobalGame&&(GlobalGame.pause(),GlobalGame._isPaused?qs(".game-paused").style.display="block":(console.log("Game unpaused!"),qs(".game-paused").style.display="none"))}function restartGame(){if(GlobalGame){GlobalGame.restart();for(const e in assets.sounds.result)assets.sounds.result[e].stop();qs(".game-paused").style.display="none",qs(".play-result").classList.remove("show"),doms.playResult.accBar.classList.remove("show")}}function exitGame(){if(GlobalGame){GlobalGame.destroy(!0),GlobalGame=void 0;for(const e in assets.sounds.result)assets.sounds.result[e].stop();qs(".game-paused").style.display="none",qs(".play-result").classList.remove("show"),doms.playResult.accBar.classList.remove("show"),doms.fileSelect.style.display="block"}}window.pauseGame=pauseGame;window.restartGame=restartGame;window.exitGame=exitGame;function showGameResultPopup(e){let t=e.chart,i=e.judgement;qs(".play-result .song-info .title").innerHTML=t.info.name||"Untitled",qs(".play-result .song-info .subtitle.artist").innerHTML=t.info.artist||"Unknown",qs(".play-result .song-info .subtitle.diff").innerHTML=t.info.difficult||"SP Lv.?",e._settings.challengeMode&&(qs(".play-result .song-info .subtitle.diff").innerHTML+=" (challenge)"),Number(e._settings.speed.toFixed(2))!==1&&(qs(".play-result .song-info .subtitle.diff").innerHTML+=" (x"+e._settings.speed.toFixed(2)+")"),i.score.judgeLevel==6?qs(".play-result .judge-icon").innerText="φ":i.score.judgeLevel==5?qs(".play-result .judge-icon").innerText="V":i.score.judgeLevel==4?qs(".play-result .judge-icon").innerText="S":i.score.judgeLevel==3?qs(".play-result .judge-icon").innerText="A":i.score.judgeLevel==2?qs(".play-result .judge-icon").innerText="B":i.score.judgeLevel==1?qs(".play-result .judge-icon").innerText="C":qs(".play-result .judge-icon").innerText="False";const s=document.querySelector(".judge-icon");s.style.color="",s.style.textShadow="",i.score.APType==2?(qs(".play-result .extra-info").innerText="All Perfect",s.style.color="#EBCF0E",s.style.textShadow="0px 0px 20px #EBCF0E"):i.score.APType==1?(qs(".play-result .extra-info").innerText="Full Combo",s.style.color="#2E86FA",s.style.textShadow="0px 0px 20px #2E86FA"):qs(".play-result .extra-info").innerText="",i.score._autoPlay&&(qs(".play-result .extra-info").innerText="Auto Play"),qs(".play-result .info-bar.score .score").innerText=n(i.score.score.toFixed(0)),qs(".play-result .info-bar.score .acc").innerText="Accuracy "+(i.score.acc*100).toFixed(2)+"%",qs(".play-result .info-bar.detail .detail-single .value.perfect").innerText=i.score.perfect,qs(".play-result .info-bar.detail .detail-single .value.good").innerText=i.score.good,qs(".play-result .info-bar.detail .detail-single .value.bad").innerText=i.score.bad,qs(".play-result .info-bar.detail .detail-single .value.miss").innerText=i.score.miss,qs(".play-result .info-bar.detail .max-combo").innerText="Max Combo "+i.score.maxCombo;{qs(".play-result .info-bar.acc-bar .judge-histogram").innerHTML="";let r=(e._settings.challengeMode?90:180)/1e3,a=0,o={};e.chart.notes.forEach(h=>{h.isFake||isNaN(h.scoreTime)||(o[Math.ceil(h.scoreTime/r*50)]=o[Math.ceil(h.scoreTime/r*50)]?o[Math.ceil(h.scoreTime/r*50)]+1:1)});for(const h in o)o[h]>a&&(a=o[h]);for(const h in o){let c=document.createElement("div");c.style.opacity=o[h]/a,c.style.setProperty("--pos",Number(h)+50+"%"),e._settings.challengeMode?-22.22222222222222<=h&&h<=40/180*100?c.style.background="#FFECA0":-41.66666666666667<=h&&h<=75/180*100?c.style.background="#B4E1FF":c.style.background="#6c4343":-22.22222222222222<=h&&h<=80/360*100?c.style.background="#FFECA0":-44.44444444444444<=h&&h<=160/360*100?c.style.background="#B4E1FF":c.style.background="#6c4343",qs(".play-result .info-bar.acc-bar .judge-histogram").appendChild(c)}let l=document.createElement("div");l.className="center",qs(".play-result .info-bar.acc-bar .judge-histogram").appendChild(l)}{let r=t.info.difficult?/([a-zA-Z]+)\s[lL][vV]\.?(.+)/.exec(t.info.difficult):null;switch(r=r&&r.length>=1?r[1]:"IN",r?r.toLowerCase():"in"){case"ez":{assets.sounds.result.ez.stop(),assets.sounds.result.ez.play();break}case"hd":{assets.sounds.result.hd.stop(),assets.sounds.result.hd.play();break}case"at":{assets.sounds.result.at.stop(),assets.sounds.result.at.play();break}case"sp":{i.score.levelPassed?(assets.sounds.result.spGlitch.stop(),assets.sounds.result.spGlitch.play()):(assets.sounds.result.sp.stop(),assets.sounds.result.sp.play());break}case"in":default:{assets.sounds.result.in.stop(),assets.sounds.result.in.play();break}}}qs(".play-result").classList.add("show");function n(r){let a=r+"";for(;a.length<7;)a="0"+a;return a}}function switchTab(e){let t=e.target,i=t.dataset.tabId;if(document.querySelector("div.tab div.content > *#tab-"+i)){for(const s of document.querySelectorAll("div.tab div.bar > *"))s.classList.remove("active");for(const s of document.querySelectorAll('div.tab div.content > *[id^="tab-"]'))s.style.display="none";t.classList.add("active"),document.querySelector("div.tab div.content > *#tab-"+i).style.display="block"}}async function loadChartFiles(e){return new Promise(async s=>{let n=[...e],r=0;const a=n.length,o=async l=>{try{if(!l)return;let h=l.name.split("."),c=h[h.length-1];if(l.format=c,doms.chartPackFileReadProgress.innerText=`Loading files: ${l.name} (${r+1}/${a})`,l.name==="info.csv"){let d=await t(l),u=CsvReader(d);files.infos.push(...u),files.all[l.name]=u}else if(l.name==="line.csv"){let d=await t(l),u=CsvReader(d);files.lines.push(...u),files.all[l.name]=u}else if(l.name==="extra.json"){files.effects instanceof Array&&(console.warn("Already loaded an extra.json, overwriting previous"),files.effects=null);let d=await t(l),u=Effect.from(JSON.parse(d));files.effects=u,files.all[l.name]=u}else if(l.name==="Settings.txt"||l.name==="info.txt"){let d=await t(l),u=SettingsReader(d);files.infos.push(u),files.all[l.name]=u}else try{let d=await JSZip.loadAsync(l,{createFolders:!1});for(const u in d.files){if(d.files[u].dir)continue;let m=d.files[u],f=new File([await m.async("blob")],u,{type:"",lastModified:m.date});n.push(f)}}catch{try{let u=await t(l),m=typeof u=="string"?JSON.parse(u):u;m=Chart.from(m),files.charts[l.name]=m,files.all[l.name]=m,doms.file.chart.appendChild(i(l))}catch{try{let m=await createImageBitmap(l),f=await Texture.from(m);Texture.addToCache(f,l.name),files.images[l.name]=f,files.all[l.name]=f,doms.file.bg.appendChild(i(l))}catch{try{let f=await loadAudio(l,!1,!1);files.musics[l.name]=f,files.all[l.name]=f,doms.file.music.appendChild(i(l))}catch{try{let p=await t(l),g=Shader.from(p,l.name);files.shaders[l.name]=g,files.all[l.name]=g}catch{console.error("Unsupported file:",l.name)}}}}}}catch(h){console.error(`Error processing file ${l.name}:`,h)}finally{r++,r===n.length&&(doms.file.chart.childNodes.length>=1&&doms.file.music.childNodes.length>=1&&(doms.file.chart.dispatchEvent(new Event("input")),doms.startBtn.disabled=!1),doms.chartPackFileReadProgress.innerText="All done!",s())}};for(let l=0;l<n.length;l++)await o(n[l])});function t(s){return new Promise((n,r)=>{let a=new FileReader;a.onloadend=()=>n(a.result),a.onerror=o=>r(o),a.readAsText(s)})}function i(s){let n=document.createElement("option");return n.innerText=n.value=s.name,n}}async function initConsoleEasterEgg(){try{let t=await e("./icons/64.png");console.log("%c ","padding:32px;background:url("+t+") center center no-repeat;")}catch{}console.log("%cphi-chart-render%cv0.0.1-beta15-15eaf44","padding:8px;background-color:#1C1C1C;color:#FFF","padding:8px;background-color:#1E90FF;color:#FFF;");try{let t=await e("./icons/github.png");console.log("%chttps://github.com/MisaLiu/phi-chart-render","padding:4px;padding-left:22px;background:url("+t+") left center no-repeat;background-color:#1C1C1C;background-size:contain;color:#FFF;")}catch{console.log("%cGitHub: https://github.com/MisaLiu/phi-chart-render","padding:4px;background-color:#1C1C1C;color:#FFF;")}console.groupCollapsed("❤️ Support me");try{let t=await e("./icons/patreon.png");console.log("%chttps://patreon.com/HIMlaoS_Misa","padding:4px;padding-left:22px;background:url("+t+") left center no-repeat;background-color:#f3455c;background-size:contain;color:#FFF;")}catch{console.log("%Patreon: https://patreon.com/HIMlaoS_Misa","padding:4px;background-color:#f3455c;color:#FFF;")}try{let t=await e("./icons/afdian.png");console.log("%chttps://afdian.net/@MisaLiu","padding:4px;padding-left:22px;background:url("+t+") left center no-repeat;background-color:#946CE6;background-size:contain;color:#FFF;")}catch{console.log("%爱发电: https://afdian.net/@MisaLiu","padding:4px;background-color:#946CE6;color:#FFF;")}console.groupEnd();function e(t){return new Promise((i,s)=>{fetch(t).then(n=>n.blob()).then(n=>{let r=new FileReader;r.onload=()=>{i(r.result)},r.onerror=a=>{s(a)},r.readAsDataURL(n)})})}}function PlayLikeYouNeverDidBefore(e,t){let i=1+.5*Math.sin(1.5708*(t%2));e.chart.music.speed=i,e.chart.sprites.info.songName.text=e.chart.info.name+" (x"+Math.round(i*100)/100+")"}window.fullscreen=fullscreen;window.pauseGame=pauseGame;window.restartGame=restartGame;window.exitGame=exitGame;
//# sourceMappingURL=index-xW_uqiHb.js.map
